<!doctype html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goldstine研究所 &middot; Goldstine研究所</title>

    <meta name="description" content="mosuke5&#39;s blog">
    <link rel="canonical" href="https://mosuke.tech/">

    <meta name="generator" content="Hugo 0.20" />
    <meta name="twitter:card" content="summary">
    
    <meta name="twitter:title" content="Goldstine研究所 &middot; Goldstine研究所">
    <meta name="twitter:description" content="mosuke5&#39;s blog">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Goldstine研究所 &middot; Goldstine研究所">
    <meta property="og:description" content="mosuke5&#39;s blog">

    <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Oxygen:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css">

    <link rel="stylesheet" href="https://mosuke.tech/css/all.min.css">
    <link rel="stylesheet" href="https://mosuke.tech/css/mosuke5.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

    <link rel="alternate" type="application/rss+xml" title="Goldstine研究所" href="https://mosuke.tech/index.xml" />
    <link rel="icon" type="image/png" href="/image/favicon.png">
</head>
<body>


<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
    <div class="header">
        <hgroup>
            <h1 class="brand-title"><a href="https://mosuke.tech">Goldstine研究所</a></h1>
            <h2 class="brand-tagline"> mosuke5&#39;s blog </h2>
        </hgroup>

        <nav class="nav">
            <ul class="nav-list">
                
                
            </ul>
        </nav>
    </div>
</div>


    <div class="content pure-u-1 pure-u-md-3-4">
        <div>
            
            <div class="posts">
                
                
                <h1 class="content-subhead">19 Jul 2015, 13:58</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://mosuke.tech/entry/2015/07/19/135844/" class="post-title">DockerとWebSocketを使って、vimの設定をブラウザで即体感できるサービスを作った</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">mosuke5</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-vim" href="https://mosuke.tech/categories/vim">vim</a><a class="post-category post-category-vim::factory" href="https://mosuke.tech/categories/vimfactory">vim::factory</a><a class="post-category post-category-vimfactory" href="https://mosuke.tech/categories/vimfactory">vimfactory</a><a class="post-category post-category-docker" href="https://mosuke.tech/categories/docker">docker</a><a class="post-category post-category-websocket" href="https://mosuke.tech/categories/websocket">websocket</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p><body>
<p>2014年の秋から<code>@mogulla3</code>と定期的にインフラ関連技術の勉強会をやってきましたが、<br>
インプットの勉強会だけでは飽き足らず、いつしかサービスを作る中でインフラ関連技術を駆使し勉強したいと思うように…</p></p>

<p>そして、普段使っている<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>を題材に、<br>
<b><span style="font-size: 150%"><a class="keyword" href="http://d.hatena.ne.jp/keyword/vim">vim</a>の設定をブラウザ上で即体感できるサービス <a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>::Factory</span></b><br>
を開発しました。</p>

<p>本記事は<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>::Factoryの簡単な紹介と技術的な仕組みについて記述しています。</p>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>::Factoryはこちら。<br>
<a href="http://vimfactory.com/">http://vimfactory.com/</a></p>

<h1>1. <a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>::Factoryについて</h1>

<h2>1-1. <a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>::Factoryってなに？？</h2>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>::Factoryは、選択した<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>の設定を、ブラウザ上で「即体感」できるサービスです。<br>
数多くあり複雑な<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>の設定を容易にし、お気に入りの<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>探しをサポートすることを目指しています。</p>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mosuke5/20150719/20150719155723.png" alt="f:id:mosuke5:20150719155723p:plain" title="f:id:mosuke5:20150719155723p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<h2>1-2. なんで作ったの？</h2>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>の設定ってたくさんあってどれを選んでいいかわからなかったり、<br>
設定したもののどう変わったかイマイチわからなかったりしませんか？</p>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>の設定がどのように反映されるか、もっと簡単に体験したいと考えたからです。</p>

<p>あと、例えば<a class="keyword" href="http://d.hatena.ne.jp/keyword/Github">Github</a>で100star以上をつける人の<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>をブラウザ上で体験できたらいいなと思っていて、<br>
それを実現のための第一歩としてこのサービスを作りました。</p>

<h2>1-3. このサービスの最大の特徴は？</h2>

<p>このサービスの最大の特徴はなんといっても<b>「ブラウザ上で<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>が体感できること」</b>です。</p>

<p>今までは<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>の設定を試そうと思ったら、ネットで調べて自分の<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>に反映させて…という作業が必要でしたが、<br>
ブラウザ上で設定を即体感するという新しい体験を提供するために力を注いできました。<br>
その実現方法については、後述しています。</p>

<h2>1-4. 紹介動画</h2>

<p>詳しくは、実際に試してもらうのが早いと思いますが、簡単な操作動画を用意してみました。<br>
モバイルからこのサービスはちょっと使えないので、モバイルで読んでいる方は動画でお楽しみください(笑)<br>
<iframe width="480" height="270" src="https://www.youtube.com/embed/j20agcBcAec?feature=oembed" frameborder="0" allowfullscreen></iframe><cite class="hatena-citation"><a href="https://www.youtube.com/watch?v=j20agcBcAec&amp;feature=youtu.be">www.youtube.com</a></cite></p>

<h1>2. <a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>::Factoryの技術について</h1>

<p>ここから<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>::Factoryの技術について一部ではありますがご紹介します。</p>

<h2>2-1. ブラウザ上での<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>を実現した技術</h2>

<p>ブラウザ上で<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>を実現しようと思うと、ぱっと思いつくのは<a class="keyword" href="http://d.hatena.ne.jp/keyword/JavaScript">JavaScript</a>で<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>そのものを実装してしまおうというものかもしれません。<br>
ですが、JSで<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>を実装することってどれくらい難しいでしょうか？<br>
少なくともぼくにはそんなことはできませんし、できたとして質の悪いものになってしまうと思います。</p>

<p>そこで思いついたのが、一般的なターミナルソフトと同様にサーバ上で<a class="keyword" href="http://d.hatena.ne.jp/keyword/vim">vim</a>を起動し、<br>
そのターミナル情報をブラウザ上で表示するという方法です。<br>
この方法であれば自ら<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>を実装せずとも<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>を再現できます。イメージは下記のとおりです。<br>
<span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mosuke5/20150718/20150718230605.png" alt="f:id:mosuke5:20150718230605p:plain" title="f:id:mosuke5:20150718230605p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p>また、サービスとして上記を行うには、接続してきたユーザごとに<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>を用意する必要があります。</p>

<p>これらを実現するために利用したのが<b>Docker</b>と<b>WebSocket</b>です。<br>
dockerコンテナ上で<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>を起動し、そのターミナル情報をWebSocketでブラウザに送信するようにしました。
<span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mosuke5/20150720/20150720002840.png" alt="f:id:mosuke5:20150720002840p:plain" title="f:id:mosuke5:20150720002840p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p>dockerはコンテナ型の仮想化なので起動がとてもはやく、<br>
httpのリクエストが来てからdockerコンテナを立ち上げても十分なほどのはやさをもっています。</p>

<h2>2-2. 全体構成</h2>

<p>システムの全体構成は以下のような感じです。<br>
※実際の役割は図のとおりですが、サーバはこんなに多くありません。</p>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mosuke5/20150719/20150719124021.png" alt="f:id:mosuke5:20150719124021p:plain" title="f:id:mosuke5:20150719124021p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<h2>2-3. 利用した技術とか<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C4%A1%BC%A5%EB">ツール</a>のまとめ</h2>

<p>振り返りも兼ねて利用した技術・<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C4%A1%BC%A5%EB">ツール</a>を一覧にまとめておきます。</p>

<ul>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/Ruby">Ruby</a></li>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/Sinatra">Sinatra</a></li>
<li>thin</li>
<li>node.js</li>
<li>Websocket</li>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/memcached">memcached</a></li>
<li>docker</li>
<li>nginx</li>
<li>centos7</li>
<li>Ansible</li>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/Vagrant">Vagrant</a></li>
<li>gitlab</li>
<li>mackerel</li>
<li>slack</li>
<li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/esa">esa</a>.io(ドキュメント管理)</li>
</ul>

<h1>3. まとめ</h1>

<p>このサービスで一番苦労したことはやっぱりブラウザ上での<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>の実現部分です。<br>
当初、このサービスを思いついた時、実現不可能だ…とあきらめました。<br>
というのもJS（アプリケーションサイド）で<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>をどう実装しようかしか考えていなかったからです。</p>

<p>ですが、ふとしたときに上記の別の方法（インフラサイド）での実現方法を思いつきました。</p>

<p>このサービスを作るきっかけは、インフラ技術のインプット勉強だけでは飽きたらず、<br>
サービスを開発・運用していくなかでインフラ技術を磨いていきたいというものでしたが、<br>
インプットの勉強があってこそインフラサイドからの実現方法を見つけられたようにも思いました。</p>

<p>今後、運用を通してさらなるパワーアップができたらいいなと思います。</p>

<h1>4. 最後に</h1>

<p>最後になりますが、
完全な趣味で作ってしまったサービスで、今後どのように展開していこうか何も考えていません。<br>
まずは、このように公開し皆様に利用して頂いて、フィードバックなど頂いてから考えようと思っています。</p>

<p>サービスに関するご意見等あれば、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Twitter">Twitter</a>やメールで書いてくれると大変嬉しいです。</p>

<p>お問い合せはこちら:</p>

<ul>
<li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Twitter">Twitter</a>: <a href="https://twitter.com/mosuke5">もーすけ (@mosuke5) | Twitter</a> or <a href="https://twitter.com/mogulla3">もぐらマン (@mogulla3) | Twitter</a>
</li>
<li>e-mail: ilab.vimfactory+info@<a class="keyword" href="http://d.hatena.ne.jp/keyword/gmail">gmail</a>.com</li>
</ul>

<p>では、みなさんも<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>ライフを楽しみましょう！</p>

<p><p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Vim">Vim</a>::Factoryはこちら。<br>
<a href="http://vimfactory.com/">http://vimfactory.com/</a></p>
</body></p>

                    </div>
                </section>
                
                
                
                <h1 class="content-subhead">17 Jun 2015, 21:28</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://mosuke.tech/entry/2015/06/17/212852/" class="post-title">PostgreSQL環境でFuelPHPのDBマイグレーションを使う</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">mosuke5</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-php" href="https://mosuke.tech/categories/php">php</a><a class="post-category post-category-fuelphp" href="https://mosuke.tech/categories/fuelphp">fuelphp</a><a class="post-category post-category-DBマイグレーション" href="https://mosuke.tech/categories/db%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3">DBマイグレーション</a><a class="post-category post-category-PostgreSQL" href="https://mosuke.tech/categories/postgresql">PostgreSQL</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p><body>
<p>今更<a class="keyword" href="http://d.hatena.ne.jp/keyword/FuelPHP">FuelPHP</a>感はあるのだが、<br>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/postgresql">postgresql</a>利用時の<a class="keyword" href="http://d.hatena.ne.jp/keyword/FuelPHP">FuelPHP</a>のmigration導入について、注意点をまとめた。<br>
でも、結論は納得がいっていない。</p></p>

<h1>0. 前提</h1>

<p>下記の環境で行ったものです。<br>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>: 5.5.7<br>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/FuelPHP">FuelPHP</a>: 1.7<br>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Postgresql">Postgresql</a>: 9.4</p>

<h1>1. テーブル<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CA%B8%BB%FA%A5%B3%A1%BC%A5%C9">文字コード</a>の問題</h1>

<h1><a class="keyword" href="http://d.hatena.ne.jp/keyword/%BB%F6%BE%DD">事象</a></h1>

<p>公式サイトのサンプルの通りはじめに<code>app/migrations/001_example.php</code>を作り、migrationを実行した。</p>

<p><code>app/migrations/001_example.php</code>の作成</p>

<pre><code class="language-php">&lt;?php
namespace Fuel\Migrations;
class Example
{
    function up()
    {
        \DBUtil::create_table('posts', array(
            'id' =&gt; array('type' =&gt; 'int', 'constraint' =&gt; 5),
            'title' =&gt; array('type' =&gt; 'varchar', 'constraint' =&gt; 100),
            'body' =&gt; array('type' =&gt; 'text'),
        ), array('id'));
    }
    
    function down()
    {
        \DBUtil::drop_table('posts');
    }
}
</code></pre>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%DE%A5%A4%A5%B0%A5%EC%A1%BC%A5%B7%A5%E7%A5%F3">マイグレーション</a>実行すると以下のエラーに襲われた。</p>

<pre><code>$ php oil refine migrate
Uncaught exception Fuel\Core\Database_Exception: SQLSTATE[42601]: Syntax error: 7 ERROR: syntax error at or near &quot;DEFAULT&quot;
LINE 5: )DEFAULT CHARACTER SET utf8;
^ with query: &quot;CREATE TABLE IF NOT EXISTS &quot;migration&quot; (
&quot;type&quot; varchar(25) NOT NULL,
&quot;name&quot; varchar(50) NOT NULL,
&quot;migration&quot; varchar(100) DEFAULT '' NOT NULL
)DEFAULT CHARACTER SET utf8;&quot; 
</code></pre>

<h1>理由</h1>

<p>しょっぱなから躓くわけだが…</p>

<p>初めて<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%DE%A5%A4%A5%B0%A5%EC%A1%BC%A5%B7%A5%E7%A5%F3">マイグレーション</a>を実行する際には<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%DE%A5%A4%A5%B0%A5%EC%A1%BC%A5%B7%A5%E7%A5%F3">マイグレーション</a>管理用のテーブルを作る。<br>
そのテーブルを作る<a class="keyword" href="http://d.hatena.ne.jp/keyword/SQL">SQL</a>が下記の通り発行されている。</p>

<pre><code class="language-sql">CREATE TABLE IF NOT EXISTS &quot;migration&quot; (
&quot;type&quot; varchar(25) NOT NULL,
&quot;name&quot; varchar(50) NOT NULL,
&quot;migration&quot; varchar(100) DEFAULT '' NOT NULL
)DEFAULT CHARACTER SET utf8;
</code></pre>

<p>理由は単純で、<a class="keyword" href="http://d.hatena.ne.jp/keyword/postgresql">postgresql</a>のcreate tableでは次のdefault構文は利用できないから。</p>

<pre><code class="language-sql">create table xxxx ( ) default character set xxx;
</code></pre>

<p>なぜ、利用できない構文の<a class="keyword" href="http://d.hatena.ne.jp/keyword/SQL">SQL</a>が発行されたのか？<br>
それは単に<a class="keyword" href="http://d.hatena.ne.jp/keyword/FuelPHP">FuelPHP</a>の問題です。次期バージョンでは解決されることを祈る。</p>

<h1>解決方法</h1>

<p>解決方法は下記の記事がわかりやすかった。
<iframe src="//hatenablog-parts.com/embed?url=http%3A%2F%2Fqiita.com%2Fhirobow%2Fitems%2F8c2c379b33f0040480b7" title="FuelPHP で PDOによるPostgreSQL接続の罠 - Qiita" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"><a href="http://qiita.com/hirobow/items/8c2c379b33f0040480b7">FuelPHP で PDOによるPostgreSQL接続の罠 - Qiita</a></iframe><cite class="hatena-citation"><a href="http://qiita.com/hirobow/items/8c2c379b33f0040480b7">qiita.com</a></cite></p>

<p>簡単に言うとdbのコンフィグで、charsetをnullにすると<code>DEFAULT CHARACTER SET xxx</code>部分が発行されない。</p>

<pre><code>'charset' =&gt; NULL, 
</code></pre>

<h1>2. PRIMARY KEYの問題</h1>

<h1><a class="keyword" href="http://d.hatena.ne.jp/keyword/%BB%F6%BE%DD">事象</a></h1>

<p>1.の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CA%B8%BB%FA%A5%B3%A1%BC%A5%C9">文字コード</a>の問題は解決して、さあもう一度<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%DE%A5%A4%A5%B0%A5%EC%A1%BC%A5%B7%A5%E7%A5%F3">マイグレーション</a>を！と思って実行するもさらなるエラーに阻まれる。</p>

<pre><code>$ php oil refine migrate
Uncaught exception Fuel\Core\Database_Exception: SQLSTATE[42601]: Syntax error: 7 ERROR: syntax error at or near &quot;(&quot;
LINE 2: &quot;id&quot; int(5) NOT NULL,
^ with query: &quot;CREATE TABLE IF NOT EXISTS &quot;users&quot; (
&quot;id&quot; int(5) NOT NULL,
&quot;name&quot; text NOT NULL,
PRIMARY KEY &quot;id&quot; (&quot;id&quot;)
);&quot; 
</code></pre>

<p>理由は1のときと一緒。<br>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/postgresql">postgresql</a>では以下の構文は使えないのだ…</p>

<pre><code>PRIMARY KEY &quot;id&quot; (&quot;id&quot;) 
</code></pre>

<h1>3. 結局</h1>

<p>つまるところ<a class="keyword" href="http://d.hatena.ne.jp/keyword/FuelPHP">FuelPHP</a>(すくなくとも1.7までは)では、<a class="keyword" href="http://d.hatena.ne.jp/keyword/postgresql">postgresql</a>で<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%DE%A5%A4%A5%B0%A5%EC%A1%BC%A5%B7%A5%E7%A5%F3">マイグレーション</a>を行う環境がちゃんと整っていないということ。<br>
しかたないので、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%DE%A5%A4%A5%B0%A5%EC%A1%BC%A5%B7%A5%E7%A5%F3">マイグレーション</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/SQL">SQL</a>は生<a class="keyword" href="http://d.hatena.ne.jp/keyword/SQL">SQL</a>を書くことにしました。</p>

<p>PRIMARY KEYを後から別途で付与するとか考えたけど、<br>
ほかにも罠がありそうだったので、安全な生<a class="keyword" href="http://d.hatena.ne.jp/keyword/SQL">SQL</a>を採用しました。<br>
バージョン1.8では直っている?とのことだが、まだdevelopmentだったのでこれも見送り。</p>

<p>うむ。。。</p>

<p><p>&lt;参考&gt;
<iframe src="//hatenablog-parts.com/embed?url=http%3A%2F%2Fimprove-future.com%2Favailable-dbms-in-fuelphp.html" title="FuelPHP で使用可能なデータベース" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"><a href="http://improve-future.com/available-dbms-in-fuelphp.html">FuelPHP で使用可能なデータベース</a></iframe><cite class="hatena-citation"><a href="http://improve-future.com/available-dbms-in-fuelphp.html">improve-future.com</a></cite></p>
</body></p>

                    </div>
                </section>
                
                
                
                <h1 class="content-subhead">13 Jun 2015, 23:19</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://mosuke.tech/entry/2015/06/13/231917/" class="post-title">Ajaxの嫌いだった部分をJsRenderで心地良くした</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">mosuke5</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-javascript" href="https://mosuke.tech/categories/javascript">javascript</a><a class="post-category post-category-JsRender" href="https://mosuke.tech/categories/jsrender">JsRender</a><a class="post-category post-category-ajax" href="https://mosuke.tech/categories/ajax">ajax</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p><body>
<h1>1. はじめに</h1></p>

<p>ぼくはフロントエンドは本業ではありません。<br>
jsはあまり好きではありません。<br>
そして<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ajax">Ajax</a>通信後にhtmlをアウトプットする際にjsの変数の中にhtmlを書いていく<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BD%A1%BC%A5%B9%A5%B3%A1%BC%A5%C9">ソースコード</a>がもっと好きではありません。(後述)<br>
それをJSテンプレートエンジンを使ってシンプルにしてみたって話です。
（JsRenderの使い方を書いたものではありません。）</p>

<h1>2. <a class="keyword" href="http://d.hatena.ne.jp/keyword/Ajax">Ajax</a>が嫌いだった理由</h1>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Ajax">Ajax</a>はユーザ体感的にはいいのだけれど、<br>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ajax">Ajax</a>の結果受け取った<a class="keyword" href="http://d.hatena.ne.jp/keyword/json">json</a>などのデータを使ってhtmlを出力とかやると<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BD%A1%BC%A5%B9%A5%B3%A1%BC%A5%C9">ソースコード</a>が煩雑になるので嫌いだった。</p>

<p>例として<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ajax">Ajax</a>で/xxxxxにリクエストを投げて、その結果(<a class="keyword" href="http://d.hatena.ne.jp/keyword/json">json</a>データ)を使ってhtmlを出力するものを考えると。</p>

<pre><code class="language-javascript">/* jsonデータは下記が返ってくるとする
[
    {
        id: '1',
        name: 'らーめん',
        text: 'らーめんはやっぱり濃厚鶏そばです。'
    },
    {
        id: '2',
        name: 'うどん',
        text: 'うどんはやっぱり釜揚げうどんです。'
    }
]
*/
$.ajax({
  type: &quot;GET&quot;,
  url: &quot;/xxxxx&quot;,
  dataType: &quot;json&quot;,
  success: function(data){
    var html = '';
    data.forEach(function (e) {
      html += '&lt;div id=&quot;' + e.id + '&quot;&gt;';
      html += '&lt;h1&gt;' + e.name + '&lt;/h1&gt;';
      html += '&lt;p&gt;' + e.text + '&lt;/p&gt;';
      html += '&lt;/div&gt;';
    });
    $(&quot;#result&quot;).append(html);
  },
})
</code></pre>

<p>jsの変数の中にhtmlが含まれる。<br>
<b>そう、jsの変数の中にhtmlが！！</b><br>
この規模ならまだいいが、もう少しhtmlが肥大化してくると最悪である。<br>
これがどうしても許せない。</p>

<h1>3.jsのテンプレートエンジンを使ってみた</h1>

<p>上の問題をなんとかできないかと思っていたところ、jsのテンプレートエンジンにいきついた。<br>
jsのテンプレートエンジンは多数あるのだが今回はJsRenderを採用し、<a class="keyword" href="http://d.hatena.ne.jp/keyword/ajax">ajax</a>を心地よく使うことができるようになった。</p>

<p><a href="http://www.jsviews.com/">JsRender/JsViews</a></p>

<h3>3-1. jsテンプレートエンジンの選定について</h3>

<p>以下のまとめなど参考にするといいが、多数ある。
<iframe src="//hatenablog-parts.com/embed?url=http%3A%2F%2Fqiita.com%2FKumamon%2Fitems%2F7db7c8f5e5ace3b40874" title="JavaScriptテンプレートエンジンまとめ - Qiita" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"><a href="http://qiita.com/Kumamon/items/7db7c8f5e5ace3b40874">JavaScriptテンプレートエンジンまとめ - Qiita</a></iframe><cite class="hatena-citation"><a href="http://qiita.com/Kumamon/items/7db7c8f5e5ace3b40874">qiita.com</a></cite></p>

<p>用途としては下記のような感じで選んだ。</p>

<ul>
<li>クライアントサイドで利用できる

<ul>
<li>特にサーバサイドで使える必要はなかった</li>
</ul>
</li>
<li>簡単に利用できること。学習コストが低そうなこと</li>
<li>for文やif文はつかえること</li>
<li>プレ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B3%A5%F3%A5%D1%A5%A4%A5%EB">コンパイル</a>とかは必要なかった</li>
</ul>

<h3>3-2. JsRenderを使えばここまで<a class="keyword" href="http://d.hatena.ne.jp/keyword/ajax">ajax</a>がシンプルになった</h3>

<p>JsRenderを利用して先ほどの<a class="keyword" href="http://d.hatena.ne.jp/keyword/ajax">ajax</a>部分を書き直すと以下のようになる。</p>

<h4>js側</h4>

<pre><code class="language-javascript">$.ajax({
  type: &quot;GET&quot;,
  url: &quot;/xxxxx&quot;,
  dataType: &quot;json&quot;,
  success: function(data){
    var template = $.templates(&quot;#result-template&quot;);   // テンプレートを指定
    var htmlOutput = template.render(data);   //テンプレート内に変数展開
    $(&quot;#result&quot;).html(htmlOutput);   //出力
  },
})
</code></pre>

<h4>html側</h4>

<pre><code class="language-html">&lt;div id=&quot;result&quot;&gt;&lt;/div&gt;
&lt;script id=&quot;result-template&quot; type=&quot;text/x-jsrender&quot;&gt;
&lt;div id=&quot;{{:id}}&quot;&gt;
  &lt;h1&gt;{{:name}}&lt;/h1&gt;
  &lt;p&gt;{{:text}}&lt;/p&gt;
&lt;/div&gt;
&lt;/script&gt;
</code></pre>

<p>何が素晴らしいって、ロジックの部分と、ビュー部分を綺麗に分離できたこと。<br>
いや、サーバサイドなら当たり前のようにやっていたことなんだけど、<br>
JsRenderを使えばクライアントサイドでも簡単に実装できて最高でした。</p>

<p><p>以上。</p>
</body></p>

                    </div>
                </section>
                
                
                
                <h1 class="content-subhead">24 May 2015, 22:02</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://mosuke.tech/entry/2015/05/24/220226/" class="post-title">他人の家のインターネットを環境を整えて分かった無線LANルータのこと</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">mosuke5</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-ネットワーク" href="https://mosuke.tech/categories/%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF">ネットワーク</a><a class="post-category post-category-無線LANルーター" href="https://mosuke.tech/categories/%E7%84%A1%E7%B7%9Alan%E3%83%AB%E3%83%BC%E3%82%BF%E3%83%BC">無線LANルーター</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p><body>
<p>他人の家のインターネットを環境を整えて分かった<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CC%B5%C0%FELAN">無線LAN</a>ルータのことがあったのでまとめる。</p></p>

<p>我が家のインターネット環境は以下のような構成になっている。
<span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mosuke5/20150524/20150524215405.png" alt="f:id:mosuke5:20150524215405p:plain" title="f:id:mosuke5:20150524215405p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p>この構成では<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CC%B5%C0%FELAN">無線LAN</a>ルータは<b>L3とL2の両方</b>の機器として働いている。<br>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B0%A5%ED%A1%BC%A5%D0%A5%EBIP">グローバルIP</a>とプライベートIPの両方を持っており、<br>
プライベートIPからの通信をグローバル側へルーティングする機能と、<br>
LAN内の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CA%A3%BF%F4">複数</a>の端末に接続する機能として。</p>

<p>一方、この前、他の人の家のインターネット環境を整えたのだが、<br>
以下のような構成だった。
<span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mosuke5/20150524/20150524214832.png" alt="f:id:mosuke5:20150524214832p:plain" title="f:id:mosuke5:20150524214832p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p>１つめの構成と決定的に違うところは、<a class="keyword" href="http://d.hatena.ne.jp/keyword/VDSL">VDSL</a>モデムにルータ機能もついていること。
この場合は<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CC%B5%C0%FELAN">無線LAN</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EB%A1%BC%A5%BF%A1%BC">ルーター</a>はL2の機器として働いている。<br>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CC%B5%C0%FELAN">無線LAN</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EB%A1%BC%A5%BF%A1%BC">ルーター</a>自体には<a class="keyword" href="http://d.hatena.ne.jp/keyword/IP%A5%A2%A5%C9%A5%EC%A5%B9">IPアドレス</a>はなく、<a class="keyword" href="http://d.hatena.ne.jp/keyword/DHCP">DHCP</a>で<a class="keyword" href="http://d.hatena.ne.jp/keyword/IP%A5%A2%A5%C9%A5%EC%A5%B9">IPアドレス</a>管理を行っているのも上位のルータだ。</p>

<p>この構成になるときは、一般的に光<a class="keyword" href="http://d.hatena.ne.jp/keyword/IP%C5%C5%CF%C3">IP電話</a>を利用するケースのようだ。<br>
というのも、一般的な<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CC%B5%C0%FELAN">無線LAN</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EB%A1%BC%A5%BF%A1%BC">ルーター</a>には光<a class="keyword" href="http://d.hatena.ne.jp/keyword/IP%C5%C5%CF%C3">IP電話</a>につなぐことができず、<br>
通信会社から貸与されるモデムルータを利用するため。</p>

<p>余談だが、今家では実は下記のような構成にしている。<br>
というのも、家の構造上、<a class="keyword" href="http://d.hatena.ne.jp/keyword/VDSL">VDSL</a>がでているところが納戸のようなところで、<br>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CC%B5%C0%FELAN">無線LAN</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EB%A1%BC%A5%BF%A1%BC">ルーター</a>を設置しても壁が多すぎるために電波が弱くなってしまう。<br>
そのため、リビング側へ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CC%B5%C0%FELAN">無線LAN</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EB%A1%BC%A5%BF%A1%BC">ルーター</a>を設置したかったからだ。</p>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mosuke5/20150524/20150524215424.png" alt="f:id:mosuke5:20150524215424p:plain" title="f:id:mosuke5:20150524215424p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p><p>とても単純な話だが、<br>
いろんなケースの家庭内インターネットの設定をすることで、<br>
いろいろと気づくこともあった。</p>
</body></p>

                    </div>
                </section>
                
                
                
                <h1 class="content-subhead">08 May 2015, 17:47</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://mosuke.tech/entry/2015/05/08/174732/" class="post-title">sinatra-assetpackをproduction環境で使う時にはまったー</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">mosuke5</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-ruby" href="https://mosuke.tech/categories/ruby">ruby</a><a class="post-category post-category-sinatra" href="https://mosuke.tech/categories/sinatra">sinatra</a><a class="post-category post-category-sinatra-assetpack" href="https://mosuke.tech/categories/sinatra-assetpack">sinatra-assetpack</a><a class="post-category post-category-jsminify" href="https://mosuke.tech/categories/jsminify">jsminify</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p><body>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Sinatra">Sinatra</a>アプリケーションで、JSファイルを圧縮する<a class="keyword" href="http://d.hatena.ne.jp/keyword/sinatra">sinatra</a>-assetpackを利用していて、<br>
production環境で動作させようとしたら動かなくなってしまった問題について調査した。</p></p>

<h1>起こったこと</h1>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Sinatra">Sinatra</a>を使ってアプリケーションを作っていて、development環境で完成したので、
prorudction環境で動作させようとしたら、jsのエラーが出るようになってしまい、正常に動かなくなった。</p>

<p>アクセスすると、以下のエラーがでる。要は<a class="keyword" href="http://d.hatena.ne.jp/keyword/jquery">jquery</a>がないとのこと。</p>

<pre><code>Uncaught ReferenceError: $ is not defined 
</code></pre>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/jQuery">jQuery</a>はもちろん読み込ませてるし、なんでproduction環境でだけ？？？</p>

<h1><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BD%A1%BC%A5%B9%A5%B3%A1%BC%A5%C9">ソースコード</a></h1>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sinatra">sinatra</a>のメインアプリケーションであるapp.rbには以下のように、<a class="keyword" href="http://d.hatena.ne.jp/keyword/sinatra">sinatra</a>-assetpackを利用してjsを読み込んでいる。</p>

<pre><code class="language-ruby">assets do
  serve '/js', from: 'public/js'
  serve '/bower_components', from: 'bower_components'

  js :app, '/js/app.js', [
    '/js/index.js',
  ]

  js :libs, '/js/libs.js', [
    '/bower_components/jquery/dist/jquery.js',
    '/bower_components/bootstrap/dist/js/bootstrap.js',
  ]

  js_compression :jsmin
end
</code></pre>

<p>layout.erbにはもちろん、libs.jsが先に来るように記述している。</p>

<pre><code class="language-ruby">&lt;%= js :libs %&gt;
&lt;%= js :app %&gt;
</code></pre>

<h1>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/sinatra">sinatra</a>-assetpackの挙動</h1>

<p>productionでのみ発生する<a class="keyword" href="http://d.hatena.ne.jp/keyword/%BB%F6%BE%DD">事象</a>なので、改めて<a class="keyword" href="http://d.hatena.ne.jp/keyword/sinatra">sinatra</a>-assetpackのproduction環境時の挙動を確認した。<br>
production環境では、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CA%A3%BF%F4">複数</a>のjsファイルを1つのファイルにまとめ、圧縮を行う。</p>

<h4>development環境</h4>

<p>３つのjsファイルがあったら以下のように３つ別々に読み込まれる。</p>

<pre><code class="language-html">&lt;script type='text/javascript' src='/js/vendor/jquery.283479.js'&gt;&lt;/script&gt;
&lt;script type='text/javascript' src='/js/vendor/underscore.589491.js'&gt;&lt;/script&gt;
&lt;script type='text/javascript' src='/js/app/main.589491.js'&gt;&lt;/script&gt;
</code></pre>

<h4>production環境</h4>

<p>３つあったjsファイルは1つにまとめられ、また圧縮される。</p>

<pre><code class="language-html">&lt;script type='text/javascript' src='/js/app.589491.js'&gt;&lt;/script&gt;
</code></pre>

<p>詳細はこちら<br>
<a href="https://github.com/rstacruz/sinatra-assetpack#results">rstacruz/sinatra-assetpack · GitHub</a></p>

<h1>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%BB%F6%BE%DD">事象</a>の理由</h1>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Chrome">Chrome</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%D0%A5%C3%A5%B0">デバッグ</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C4%A1%BC%A5%EB">ツール</a>のNetworkでファイルのダウンロード状況を確認してみると意外なことがわかった。
<span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mosuke5/20150508/20150508171833.png" alt="f:id:mosuke5:20150508171833p:plain" title="f:id:mosuke5:20150508171833p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p>画像が小さくて見づらいかもしれないが、
5行目と6行目のapp.jsとlibs.jsで先にlibs.jsを読み込んでいるのに、おそらく圧縮とダウンロードに時間がかかり、<br>
app.jsのほうが先にダウンロードが終わっている。</p>

<p>libs.jsには<a class="keyword" href="http://d.hatena.ne.jp/keyword/jQuery">jQuery</a>などが含まれていて、app.js内で<a class="keyword" href="http://d.hatena.ne.jp/keyword/jQuery">jQuery</a>を利用する。<br>
よって、先にapp.jsが読み込まれてしまったことで、<a class="keyword" href="http://d.hatena.ne.jp/keyword/jQuery">jQuery</a>がねーぞ！と怒られてしまったのである。</p>

<h1>対策と考慮</h1>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sinatra">sinatra</a>-assetpackなどを利用して、jsを圧縮する際には、
ファイルを1つにまとめたり圧縮したりする時間がかかることを十分に考慮しなければいけない。</p>

<p>あまり賢い手段をは言えないが、libs.jsとapp.jsひとつにまとめることで今回の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%BB%F6%BE%DD">事象</a>は避けられる。
app.rb</p>

<pre><code class="language-ruby">assets do
  serve '/js', from: 'public/js'
  serve '/bower_components', from: 'bower_components'

  js :app, '/js/app.js', [
    '/bower_components/jquery/dist/jquery.js',
    '/bower_components/bootstrap/dist/js/bootstrap.js',
    '/js/index.js',
  ]

  js_compression :jsmin
end
</code></pre>

<p><p>また、事前に圧縮しておいて、ダウンロードだけする状態にしてもいいかもしれない。<br>
<a href="https://github.com/rstacruz/sinatra-assetpack#precompile">rstacruz/sinatra-assetpack · GitHub</a></p>
</body></p>

                    </div>
                </section>
                
                
            </div>
            
<div class="pagination">
  <nav role="pagination" class="post-list-pagination">
      
      <a href="/page/7/" class="post-list-pagination-item pure-button post-list-pagination-item-prev">
        <i class="fa fa-angle-double-left"></i>&nbsp;Newer
      </a>
      
    <span class="post-list-pagination-item post-list-pagination-item-current">Page 8 of 15</span>
    
      <a href="/page/9/" class="post-list-pagination-item pure-button post-list-pagination-item-next">
        Older&nbsp;<i class="fa fa-angle-double-right"></i>
      </a>
    
  </nav>
</div>


            <hr class="footer-hr" />
<div class="">
    <div class="google-search-engine">
        <script>
          (function() {
            var cx = '012458736543810277235:x4juxtghjhg';
            var gcse = document.createElement('script');
            gcse.type = 'text/javascript';
            gcse.async = true;
            gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(gcse, s);
          })();
        </script>
		    <gcse:search></gcse:search>
    </div>
    <a class="pure-button" href="https://about.mosuke.tech "><i class="fa fa-user"></i> mosuke5</a>
    <a class="pure-button" href="/archive/"><i class="fa fa-archive"></i> Arvhive</a>
    <a class="pure-button" href="https://mosuke.tech/index.xml"><i class="fa fa-rss"></i> rss</a>
</div>
<div class="footer">
    <div class="pure-menu pure-menu-horizontal pure-menu-open">
        <ul>
            <li>&copy; <strong>mosuke5</strong> All rights reserved.<br />Powered by <a class="hugo" href="https://gohugo.io/" target="_blank">hugo</a></li>
        </ul>
    </div>
</div>
<script src="https://mosuke.tech/js/all.min.js"></script>

        </div>
    </div>
</div>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-99596316-1', 'auto');
ga('send', 'pageview');

</script>

</body>
</html>
