<!doctype html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goldstine研究所 &middot; Goldstine研究所</title>

    <meta name="description" content="mosuke5&#39;s blog">
    <link rel="canonical" href="https://mosuke.tech/">

    <meta name="generator" content="Hugo 0.20" />
    <meta name="twitter:card" content="summary">
    
    <meta name="twitter:title" content="Goldstine研究所 &middot; Goldstine研究所">
    <meta name="twitter:description" content="mosuke5&#39;s blog">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Goldstine研究所 &middot; Goldstine研究所">
    <meta property="og:description" content="mosuke5&#39;s blog">

    <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Oxygen:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css">

    <link rel="stylesheet" href="https://mosuke.tech/css/all.min.css">
    <link rel="stylesheet" href="https://mosuke.tech/css/mosuke5.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

    <link rel="alternate" type="application/rss+xml" title="Goldstine研究所" href="https://mosuke.tech/index.xml" />
    <link rel="icon" type="image/png" href="/image/favicon.png">
</head>
<body>


<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
    <div class="header">
        <hgroup>
            <h1 class="brand-title"><a href="https://mosuke.tech">Goldstine研究所</a></h1>
            <h2 class="brand-tagline"> mosuke5&#39;s blog </h2>
        </hgroup>

        <nav class="nav">
            <ul class="nav-list">
                
                
            </ul>
        </nav>
    </div>
</div>


    <div class="content pure-u-1 pure-u-md-3-4">
        <div>
            
            <div class="posts">
                
                
                <h1 class="content-subhead">15 Apr 2015, 17:11</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://mosuke.tech/entry/2015/04/15/171127/" class="post-title">Ansibleで最新のMySQLをインストールする際にハマったこと。MySQL-shared-compatのこと。</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">mosuke5</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-Ansible" href="https://mosuke.tech/categories/ansible">Ansible</a><a class="post-category post-category-Linux" href="https://mosuke.tech/categories/linux">Linux</a><a class="post-category post-category-MySQL" href="https://mosuke.tech/categories/mysql">MySQL</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p><body>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/CentOS">CentOS</a> 6.5環境でAnsibleを使って最新の<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>のセットアップをしようと思った際にハマったことをまとめた。<br>
本質的にはAnsibleというより<a class="keyword" href="http://d.hatena.ne.jp/keyword/Linux">Linux</a> <a class="keyword" href="http://d.hatena.ne.jp/keyword/RPM">RPM</a>パッケージのはなし。<br>
ついでに、しょっぼい<a class="keyword" href="http://d.hatena.ne.jp/keyword/github">github</a>を公開しました。</p></p>

<h1>(1) 本記事を書くに至った経緯</h1>

<ol>
<li>Ansibleで<a class="keyword" href="http://d.hatena.ne.jp/keyword/mysql">mysql</a>を使ったサーバを構築(CentOS6.5)することになった。

<ul>
<li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>のバージョンは5.6を採用した。</li>
</ul>
</li>
<li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>の公式<a class="keyword" href="http://d.hatena.ne.jp/keyword/rpm">rpm</a>をダウンロードしインストールした。

<ul>
<li>インストールしたもの：<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>-client, <a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>-devel, <a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>-server, <a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>-shared</li>
</ul>
</li>
<li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>-sharedをインストールする際にデフォルトの<a class="keyword" href="http://d.hatena.ne.jp/keyword/mysql">mysql</a>-libsと競合</li>
<li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/mysql">mysql</a>-libsをアンインストールし再インストール</li>
<li>Ansibleで<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>の操作をするには<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL-python">MySQL-python</a>が必要なのでインストール</li>
<li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL-python">MySQL-python</a>をインストールするにはさっきアンインストールした<a class="keyword" href="http://d.hatena.ne.jp/keyword/mysql">mysql</a>-libsが必要…(困った)</li>
<li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>-shared-compatの存在に気づく</li>
<li>備忘録に書いておくか…</li>
</ol>

<h1>(2) <a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>-shared-compatの存在</h1>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/mysql">mysql</a>-libsは多くのパッケージの依存となっており、公式のMySQL5.6をインストールすることで、<br>
他のパッケージがいれられない状況となっていた。<br>
そんな状況を解決するために<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>-shared-compatというパッケージが用意されていた。<br>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>-shared-compatは「過去の<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>バージョン向けの共有クライアントライブラリが納められているもの」だ。</p>

<p>詳細は下記参照をおすすめ。<br>
<a href="http://y-ken.hatenablog.com/entry/inside-of-libmysqlclient-with-mysql-shared-compat">MySQL-5.5.6から仕様が変わった「MySQL-shared-compat」の中身を徹底解剖 - Y-Ken Studio</a></p>

<p>ちなみに"compat"という単語がよく使われるが"compatibility"の略で「互換性」とかそういう意味。</p>

<h1>(3) <a class="keyword" href="http://d.hatena.ne.jp/keyword/Github">Github</a>で公開しました</h1>

<p>内容は今のところ死ぬほど薄いのだが、<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>をインストールするansibleを公開しました。
<a href="https://github.com/mosuke5/mysql-ansible">mosuke5/mysql-ansible · GitHub</a></p>

<p>内容はあれだが、特徴としては、インターネット上から<a class="keyword" href="http://d.hatena.ne.jp/keyword/RPM">RPM</a>をダウンロードしてインストールする際に、<br>
Ansibleでも「ダウンロード」→「インストール」の流れを踏む人が多いが、以下のようにするとシンプルになる。<br>
varsでインストールしたい<a class="keyword" href="http://d.hatena.ne.jp/keyword/rpm">rpm</a>やその取得先を記述しておいて、task側では<a class="keyword" href="http://d.hatena.ne.jp/keyword/yum">yum</a>でnameにvarsで定義した変数を読むだけでできる。</p>

<p>role/<a class="keyword" href="http://d.hatena.ne.jp/keyword/mysql">mysql</a>/vars/main.yml</p>

<pre><code class="language-yaml">mysql_url: http://ftp.jaist.ac.jp/pub/mysql/Downloads/MySQL-5.6
mysql_ver: &quot;5.6.24-1&quot;
mysql_rpms:
  - MySQL-client-{{ mysql_ver }}.el6.x86_64.rpm
  - MySQL-shared-compat-{{ mysql_ver }}.el6.x86_64.rpm
  - MySQL-shared-{{ mysql_ver }}.el6.x86_64.rpm
  - MySQL-devel-{{ mysql_ver }}.el6.x86_64.rpm
  - MySQL-server-{{ mysql_ver }}.el6.x86_64.rpm
 
</code></pre>

<p>role/<a class="keyword" href="http://d.hatena.ne.jp/keyword/mysql">mysql</a>/tasks/main.yml</p>

<pre><code class="language-yaml">- name: Install MySQL without MySQL-shared
  yum: name={{ mysql_url}}/{{ item }}
  with_items: mysql_rpms
 
</code></pre>

<p></body></p>

                    </div>
                </section>
                
                
                
                <h1 class="content-subhead">05 Apr 2015, 21:25</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://mosuke.tech/entry/2015/04/05/212518/" class="post-title">SSHエージェントフォワード後に他のユーザでgit cloneする(鍵を使う)ことに関する考察</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">mosuke5</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-CentOS7" href="https://mosuke.tech/categories/centos7">CentOS7</a><a class="post-category post-category-SSH" href="https://mosuke.tech/categories/ssh">SSH</a><a class="post-category post-category-エージェントフォワード" href="https://mosuke.tech/categories/%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%83%95%E3%82%A9%E3%83%AF%E3%83%BC%E3%83%89">エージェントフォワード</a><a class="post-category post-category-sudo" href="https://mosuke.tech/categories/sudo">sudo</a><a class="post-category post-category-Linux" href="https://mosuke.tech/categories/linux">Linux</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p><body>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>のエージェントフォワードした後に、接続したユーザとは別のユーザでgit cloneしたいことがあった。<br>
それについて調べていく中で学習したことや検討したことについてまとめた。</p></p>

<h1>0. 前提</h1>

<p>ローカルのPC(<a class="keyword" href="http://d.hatena.ne.jp/keyword/Mac">Mac</a>)上で、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Vagrant">Vagrant</a>を使用してCentOS7の仮想サーバ(testsv)を立ち上げている。</p>

<p>&lt;<a class="keyword" href="http://d.hatena.ne.jp/keyword/IP%A5%A2%A5%C9%A5%EC%A5%B9">IPアドレス</a>&gt;<br>
ローカルPC：192.168.33.1<br>
仮想サーバ：192.168.33.100</p>

<p>本記事上での「git cloneする」とは、「プライベートのGit<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%DD%A5%B8%A5%C8%A5%EA">レポジトリ</a>から<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>を利用してクローンする」ということを指す。</p>

<h1>1. <a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>のエージェントフォワードを利用したい理由</h1>

<p>まず、そもそもなぜ<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>のエージェントフォワードをする必要があったのか。<br>
最近では多くの方がご存知かつ利用していることだと思うが、仮想のサーバ上でgitを利用するときによく利用する。<br>
(もちろんそれだけの用途ではありません)</p>

<p>仮想サーバを作るたびに<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>の鍵を生成して、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Github">Github</a>等に登録するのが手間なので、<br>
ローカルのPCの鍵を他のサーバへ引き継ぐことでgit clone等を可能にするのだ。</p>

<h1>2. <a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>エージェントフォワード利用時の挙動</h1>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>のエージェントフォワードで利用される認証情報は、接続先サーバの/tmp以下に保存されます。</p>

<pre><code>[myuser@localpc ~]$ ssh -A vagrant@192.168.33.100
Last login: Sat Apr  4 xx:xx:xx 2015 from 192.168.33.1
[vagrant@testsv ~]$
[vagrant@testsv ~]$ ls -l /tmp | grep ssh
drwx------. 2 vagrant    vagrant    23  4月  4 11:35 ssh-skQVHsUCHU 
</code></pre>

<p><br>
また、接続ユーザには<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>_AUTH_SOCKという<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B4%C4%B6%AD%CA%D1%BF%F4">環境変数</a>ができ、どの認証情報を利用するか記述がされます。<br>
実際に確認してみる。<br>
確認方法は、envコマンドで<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B4%C4%B6%AD%CA%D1%BF%F4">環境変数</a>一覧を表示し、そのなかで"<a class="keyword" href="http://d.hatena.ne.jp/keyword/ssh">ssh</a>"を含むものを<a class="keyword" href="http://d.hatena.ne.jp/keyword/grep">grep</a>。</p>

<pre><code>[vagrant@testsv ~]$ env | grep -i ssh
SSH_AUTH_SOCK=/tmp/ssh-skQVHsUCHU/agent.9034
SSH_CLIENT='192.168.33.1 58017 22'
SSH_CONNECTION='192.168.33.1 58017 192.168.33.100 22'
SSH_TTY=/dev/pts/0 
</code></pre>

<p><br>
ちなみにエージェントフォワードは、認証エージェントに登録されている<a class="keyword" href="http://d.hatena.ne.jp/keyword/%C8%EB%CC%A9%B8%B0">秘密鍵</a>を<br>
ログイン先のサーバから利用できるようにする機能であり、接続元自体が変わるわけではない。<br>
試しにエージェントフォワードで接続したサーバ先から、更に<a class="keyword" href="http://d.hatena.ne.jp/keyword/ssh">ssh</a>をして、その接続状況をみてみる。</p>

<pre><code>[myuser@localpc ~]$ ssh -A vagrant@192.168.33.100
Last login: Sat Apr  4 xx:xx:xx 2015 from 192.168.33.1
[vagrant@testsv ~]$ ssh -A vagrant@192.168.33.100
Last login: Sat Apr  4 xx:xx:xx 2015 from 192.168.33.1
[vagrant@testsv ~]$
[vagrant@testsv ~]$ w
 11:50:17 up  1:55,  2 users,  load average: 0.00, 0.01, 0.05
USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
vagrant  pts/0    192.168.33.1     11:35    1.00s  0.04s  0.01s ssh -A vagrant@192.168.33.100
vagrant  pts/1    192.168.33.100   11:50    1.00s  0.01s  0.00s w 
</code></pre>

<p>wコマンドの結果の3行目のFROMをみるとわかるが、接続元が変わるわけではない。</p>

<h1>3. <a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>エージェントフォワードで接続後にrootユーザでgit cloneする</h1>

<p>例えば、rootでしかアクセスできないディレクトリにgit cloneしたいと思い、<br>
以下のようにsudoをつけてgit cloneしてみる。</p>

<pre><code>[vagrant@testsv ~]$ sudo git clone git@xxxxx.xxx:yyyy/zzzzzz.git /root/hoge
Permission denied (publickey).
fatal: Could not read from remote repository.

Please make sure you have the correct access rights
and the repository exists. 
</code></pre>

<p>sudoをつけてgit cloneしようとすると、エージェントフォワードしたのにアクセス権がありませんと言われてしまった。<br>
なぜエージェントフォワードしたのにgit cloneできないのだろうか？</p>

<p>一般的な設定ではsudo実行すると、ユーザの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B4%C4%B6%AD%CA%D1%BF%F4">環境変数</a>はrootユーザへ引き継がれず、<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>_AUTH_SOCKがないことがわかる。<br>
sudo後に<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B4%C4%B6%AD%CA%D1%BF%F4">環境変数</a>がどうなっているか確認してみる。</p>

<pre><code>[vagrant@testsv ~]$ sudo env | grep -i ssh
　(なにも表示されない) 
</code></pre>

<p><br>
sudo実行しても、<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>_AUTH_SOCKを引き継ぎたい！<br>
実はsudoで<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B4%C4%B6%AD%CA%D1%BF%F4">環境変数</a>を引き継ぐ方法がある。-Eのオプションを付けると<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B4%C4%B6%AD%CA%D1%BF%F4">環境変数</a>を引き継ぐことが可能だ。<br>
以下のように<code>sudo -E</code>とすると...</p>

<pre><code>[vagrant@testsv ~]$ sudo -E env | grep -i ssh
SSH_CLIENT=192.168.33.100 60051 22
SSH_TTY=/dev/pts/1
SSH_AUTH_SOCK=/tmp/ssh-qhGLsXBURp/agent.9113
SSH_CONNECTION=192.168.33.100 60051 192.168.33.100 22 
</code></pre>

<p><br>
<code>sudo -E</code>で<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B4%C4%B6%AD%CA%D1%BF%F4">環境変数</a>が引き継げ、<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>_AUTH_SOCKが引き継げるので、-Eをつけてsudo git cloneをトライする。</p>

<pre><code>[vagrant@testsv ~]$ sudo -E git clone git@xxxxx.xxx:yyyy/zzzzzz.git /root/hoge
Cloning into 'zzzzzz'...
remote: Counting objects: 27, done.
remote: Compressing objects: 100% (26/26), done.
remote: Total 27 (delta 13), reused 0 (delta 0)
Receiving objects: 100% (27/27), done.
Resolving deltas: 100% (13/13), done.
Checking connectivity... done. 
</code></pre>

<p>予想通り成功しました！</p>

<h3>(余談) suもsudoと同じ考え方ができる</h3>

<p>sudoだけではなくsuでのユーザ切り替えについても同じことが言える。<br>
rootユーザへ切り替えるとき、よく<code>su -</code>とハイフンをつけると思う。<br>
ハイフンをつけると、ログインシェルを使用してユーザを切り替えるので、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B4%C4%B6%AD%CA%D1%BF%F4">環境変数</a>の引き継ぎは行われない。</p>

<h1>4. rootユーザでない他のユーザでgit cloneする</h1>

<p>続いて、rootユーザではない別の一般ユーザでのgit cloneについて考える。<br>
rootユーザの時と同じ要領で、sudoコマンドを利用しotheruserという別のユーザでgit cloneをしてみる。</p>

<p>まずは、sudoコマンドでは-uでユーザの指定ができるので、otheruserに切り替えた際の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B4%C4%B6%AD%CA%D1%BF%F4">環境変数</a>をみてみる。</p>

<pre><code>[vagrant@testsv ~]$ sudo -E -u otheruser env | grep -i ssh
SSH_CLIENT=192.168.33.100 60051 22
SSH_TTY=/dev/pts/1
SSH_AUTH_SOCK=/tmp/ssh-qhGLsXBURp/agent.9113
SSH_CONNECTION=192.168.33.100 60051 192.168.33.100 22 
</code></pre>

<p><br>
rootの時と同様で予想通りな感じ。
<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>_AUTH_SOCKも引き継げているし、git clone可能だと思い以下を実行すると。</p>

<pre><code>$ sudo -E -u otheruser git clone git@xxxxx.xxx:yyyy/zzzzzz.git /home/otheruser
Permission denied (publickey).
fatal: Could not read from remote repository.

Please make sure you have the correct access rights
and the repository exists. 
</code></pre>

<p><br>
rootユーザの時とは異なってgit cloneは不可…</p>

<p>でも理由はいたって簡単。<br>
/tmp以下に保存されている認証情報は、所有者は接続したユーザで<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%DF%A5%C3%A5%B7%A5%E7%A5%F3">パーミッション</a>は600なのだ。<br>
つまり、otheruserではこの認証情報は読みこめないのである。</p>

<pre><code>[vagrant@testsv ~]$ ls -l /tmp | grep ssh
drwx------. 2 vagrant    vagrant    23  4月  4 11:35 ssh-skQVHsUCHU 
</code></pre>

<p>重要な情報なので、アクセス権は妥当ですよね。<br>
試しにアクセス権を変えてみるとgit cloneは可能だ。</p>

<pre><code>[vagrant@testsv ~]$ chmod -R 777 /tmp/ssh-skQVHsUCHU
[vagrant@testsv ~]$ sudo -E -u otheruser git clone git@xxxxx.xxx:yyyy/zzzzzz.git /home/otheruser
Cloning into 'zzzzzz'...
remote: Counting objects: 27, done.
remote: Compressing objects: 100% (26/26), done.
remote: Total 27 (delta 13), reused 0 (delta 0)
Receiving objects: 100% (27/27), done.
Resolving deltas: 100% (13/13), done.
Checking connectivity... done. 
</code></pre>

<h1>5. まとめ</h1>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>のエージェントフォワードした際の動きと、重要な観点については抑えられた。<br>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>エージェントフォワードの仕組みを見ていくことで、<br>
うかつにエージェントフォワードは利用してはいけない理由も見えてきた。</p>

<p><p>また、本題の「<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>エージェントフォワード後に、接続したユーザとは別のユーザでgit cloneしたい」だが、
そもそもそういうことをすることはNGということらしい。<br>
別のもっと賢い方法を考えろってことのようでした。</p>
</body></p>

                    </div>
                </section>
                
                
                
                <h1 class="content-subhead">22 Feb 2015, 21:13</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://mosuke.tech/entry/2015/02/22/211316/" class="post-title">Ruby, thin(bundler利用)を使った環境でのアプリの自動起動設定</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">mosuke5</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-Linux" href="https://mosuke.tech/categories/linux">Linux</a><a class="post-category post-category-init" href="https://mosuke.tech/categories/init">init</a><a class="post-category post-category-自動起動" href="https://mosuke.tech/categories/%E8%87%AA%E5%8B%95%E8%B5%B7%E5%8B%95">自動起動</a><a class="post-category post-category-Ruby" href="https://mosuke.tech/categories/ruby">Ruby</a><a class="post-category post-category-thin" href="https://mosuke.tech/categories/thin">thin</a><a class="post-category post-category-unicorn" href="https://mosuke.tech/categories/unicorn">unicorn</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p><body>
<p>bunlderを使ったWebアプリをプロダクション環境で動かすときに、アプリの起動をどうやって実現しているだろうか。</p></p>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a> Passengerを使う場合には、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>の起動がアプリの起動につながるので、
アプリの起動はあまり気にしなかったかもしれない。</p>

<p>しかし、例えばNginx × <a class="keyword" href="http://d.hatena.ne.jp/keyword/Unicorn">Unicorn</a>/thinの構成などの場合は<a class="keyword" href="http://d.hatena.ne.jp/keyword/Unicorn">Unicorn</a>やthinの起動もしなければいけなくなってくる。<br>
（あるいはこのようなケースがあるかは謎だが、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Unicorn">Unicorn</a>やthinを単体で動かそうとしている場合など）</p>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Unicorn">Unicorn</a>やthin（例ではthinを扱うが本質は同じ）の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%BC%AB%C6%B0%B5%AF%C6%B0">自動起動</a>を実現する際の勘所、注意事項をまとめた。</p>

<h1>0. 前提</h1>

<ul>
<li>CentOS6.5上で<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ruby">Ruby</a>でのWebアプリケーションを作っている。</li>
<li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A2%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3%A5%B5%A1%BC%A5%D0">アプリケーションサーバ</a>はthinを利用している。</li>
<li>また、gemパッケージ管理にbundlerを利用している。</li>
</ul>

<h1>1. 開発環境でよくするアプリの起動</h1>

<p>開発環境では、アプリケーションのログの閲覧性なども兼ねて以下のようにアプリを起動していた。</p>

<pre><code>$ bundle exec rackup
$ bundle exec thin start 
</code></pre>

<p>でも、これではいつまでたってもプロダクション環境での利用はできません。</p>

<h1>2. 上記方法ではプロダクション環境で利用できない理由</h1>

<p>当然のことながら、プロダクション環境ではいちいち手動でコマンドを実行しアプリケーションを立ち上げるわけにはいかない。<br>
例えば、なんらかの理由でサーバが再起動してしまった場合には、<br>
このままではアプリケーションが自動的に立ち上がらないため、サービスの停止につながってしまう。</p>

<p>ではどうするのか？<br>
以下の状態であることがプロダクション環境では理想なのではないだろうか？</p>

<ul>
<li>オリジナルアプリケーションもserviceコマンドで起動・停止ができる

<ul>
<li>他のサービスと同様の操作方法が可能なのでわかりやすい</li>
</ul>
</li>
<li>サーバ立ち上げ時にサービスが自動で起動される</li>
</ul>

<h1>3. 起動<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>を作ろう</h1>

<p>上記の状態にもっていくためには、起動<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>を作らなければならない。</p>

<p>起動<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>を作る…！？<br>
「作ったことないし、すぐには作れないよ〜」って思うかもしれないが、<br>
サンプルはたくさんあるし、よく見てみるとそれほど難しくはない。</p>

<p>thinを使ったサンプルを探そうと思うと数は少ないが、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Unicorn">Unicorn</a>も同じ仕組なので、
"<a class="keyword" href="http://d.hatena.ne.jp/keyword/unicorn">unicorn</a> init script"なんて検索をかけてもいろいろでてくるのでおすすめ。</p>

<p>参考ししたもの<br>
<a href="https://gist.github.com/sbeam/3454488">https://gist.github.com/sbeam/3454488</a></p>

<p>上を参考にしながら、こんな起動<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>を作ってみた。（未完成版）<br>
これを<code>/etc/init.d</code>以下へ配置する。</p>

<pre><code class="language-sh">#!/bin/bash

### BEGIN CHKCONFIG INFO
# chkconfig: 2345 55 25
# description: sample-app
### END CHKCONFIG INFO

SCRIPT_NAME=/etc/init.d/sample-app
CONFIG_PATH=/path/to/config
BUNDLE_CMD=/usr/local/bin/bundle

bundle_exec_thin ()
{
    for CONFIG_FILE in &quot;$CONFIG_PATH/*.yml&quot;; do
        SITE_DIR=`awk '/^chdir:/ { print $2; }' $CONFIG_FILE`
        cd $SITE_DIR
        $BUNDLE_CMD exec thin $1 -C $CONFIG_FILE
    done
}


case &quot;$1&quot; in
  start)
        bundle_exec_thin start
        ;;
  stop)
        bundle_exec_thin stop
        ;;
  restart)
        bundle_exec_thin restart
        ;;
  *)
        echo &quot;Usage: $SCRIPT_NAME {start|stop|restart}&quot; &gt;&amp;2
        exit 3
        ;;
esac

:
 
</code></pre>

<p>起動<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>も完成したし、実際にserviceコマンドで実行してみる。</p>

<pre><code>$ sudo service sample-app start
/usr/bin/env: ruby: No such file or directory 
</code></pre>

<p>んん。。。起動せず、撃沈…</p>

<h3>起動<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>を作る上での注意</h3>

<p>起動しなかった原因に移る前に、起動<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>を作る上での注意点を１つ。<br>
chkconfigで認識させるためには冒頭のCHKCONFIG INFO部分(<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B3%A5%E1%A5%F3%A5%C8%A5%A2%A5%A6%A5%C8">コメントアウト</a>部分)も重要になってくる。<br>
CHKCONFIG INFO部分を書かないままchkconfigでaddしようとすると以下のように怒られます。</p>

<pre><code>$ sudo chkconfig --add sample-app
service sample-app does not support chkconfig 
</code></pre>

<h1>4. serviceコマンド実行時のPATHのはなし</h1>

<p>なぜ、serviceコマンドでthinを起動できなかったのか。<br>
調べていくと意外なことがわかった。<br>
serviceコマンドを実行すると中で<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B4%C4%B6%AD%CA%D1%BF%F4">環境変数</a>のPATHが上書きされてしまう。</p>

<p>【参照】<br>
<a href="http://heartbeats.jp/hbblog/2013/06/service-start-stop.html">デーモンの起動・終了にはserviceコマンドを利用しよう - インフラエンジニアway - Powered by HEARTBEATS</a></p>

<p>試しに、起動<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>内にPATHの出力を仕込んで確かめてみる。<br>
起動<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>に<code>echo $PATH</code>を仕込んだ。</p>

<pre><code>$ sudo service sample-app start
/sbin:/usr/sbin:/bin:/usr/bin 
</code></pre>

<p>起動<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>内でbundleや<a class="keyword" href="http://d.hatena.ne.jp/keyword/ruby">ruby</a>がインストールされているディレクトリに<br>
PATHを通すことで、解決することにした。<br>
（もっと美しい方法があれば教えて下さい。。。）</p>

<h1>5. 起動<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>修正(完成版)</h1>

<p>上記の通り起動<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>を修正したものが以下。</p>

<pre><code class="language-sh">#!/bin/bash

### BEGIN CHKCONFIG INFO
# chkconfig: 2345 55 25
# description: sample-app
### END CHKCONFIG INFO

# 以下を追加
export PATH=/usr/local/bin:$PATH

SCRIPT_NAME=/etc/init.d/sample-app
CONFIG_PATH=/path/to/config
BUNDLE_CMD=/usr/local/bin/bundle

bundle_exec_thin ()
{
    for CONFIG_FILE in &quot;$CONFIG_PATH/*.yml&quot;; do
        SITE_DIR=`awk '/^chdir:/ { print $2; }' $CONFIG_FILE`
        cd $SITE_DIR
        $BUNDLE_CMD exec thin $1 -C $CONFIG_FILE
    done
}


case &quot;$1&quot; in
  start)
        bundle_exec_thin start
        ;;
  stop)
        bundle_exec_thin stop
        ;;
  restart)
        bundle_exec_thin restart
        ;;
  *)
        echo &quot;Usage: $SCRIPT_NAME {start|stop|restart}&quot; &gt;&amp;2
        exit 3
        ;;
esac

:
 
</code></pre>

<p>(PATHを通したのでbundleコマンドはフルパスでなくても大丈夫ですよ...)</p>

<p>最後に起動<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>を<code>/etc/init.d</code>以下に配置し、
忘れずにchkconfigに登録しましょう。</p>

<pre><code>$ sudo chkconfig --add sample-app 
</code></pre>

<h1>【おまけ】sudo だと<a class="keyword" href="http://d.hatena.ne.jp/keyword/ruby">ruby</a>やgem、bundleが使えない？</h1>

<p>rootユーザでは<a class="keyword" href="http://d.hatena.ne.jp/keyword/ruby">ruby</a>やgem, bundleが使えるけど、sudoで実行すると使えない…<br>
という悩みの人も多いのではないだろうか。</p>

<pre><code>$ sudo gem install xxxxx
sudo: gem: command not found 
</code></pre>

<p><p>sudoでの実行はrootユーザで実行することなのになぜ実行できないか。<br>
これはsudoを使うときに/usr/local/binが許可されていないからだ。<br>
visudoでsecure_pathの設定を見直すとよい。<br>
<a href="http://www.xmisao.com/2013/10/11/sudoers-secure_path.html">sudoersのsecure_pathについて &ndash; ぺけみさお</a></p>
</body></p>

                    </div>
                </section>
                
                
                
                <h1 class="content-subhead">17 Feb 2015, 22:05</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://mosuke.tech/entry/2015/02/17/220526/" class="post-title">勘違いしやすいFTPとSFTPの転送モードの話</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">mosuke5</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-SFTP" href="https://mosuke.tech/categories/sftp">SFTP</a><a class="post-category post-category-FTP" href="https://mosuke.tech/categories/ftp">FTP</a><a class="post-category post-category-転送モード" href="https://mosuke.tech/categories/%E8%BB%A2%E9%80%81%E3%83%A2%E3%83%BC%E3%83%89">転送モード</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p><body>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/FTP">FTP</a>やSFTPでの転送モードの話。</p></p>

<p>ついこの前、<a class="keyword" href="http://d.hatena.ne.jp/keyword/WinSCP">WinSCP</a>を利用している人が転送モードを選んでいて、<br>
「SFTPには転送モードはないと思っていたのに、転送モードを選んでいる！？」<br>
と疑問に思ったのでその辺りまとめた。</p>

<h1>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/FTP">FTP</a>のバイナリーモードと<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A2%A5%B9%A5%AD%A1%BC">アスキー</a>モード</h1>

<p>入社しはじめの頃、それまでSFTPしかほとんど使ったことなかったので、<br>
先輩に「<a class="keyword" href="http://d.hatena.ne.jp/keyword/FTP">FTP</a>ではバイナリーモードを使って…」と言われて、意味が理解できなかったときがあったのを思い出す。</p>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/FTP">FTP</a>にはファイル転送モードが２つあって、ちゃんと理解していないと思わぬところで痛い目にあう。</p>

<ul>
<li>バイナリーモード：ファイルの改行コードを変換せず転送する。</li>
<li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A2%A5%B9%A5%AD%A1%BC">アスキー</a>モード：OS側で異なる改行コードを自動的に修正して転送する。</li>
</ul>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/FTP">FTP</a>では標準では<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A2%A5%B9%A5%AD%A1%BC">アスキー</a>モードのため、なにも考えずにファイルを送るとファイルが壊れてしまったりする。<br>
昔にミスしたのは<a class="keyword" href="http://d.hatena.ne.jp/keyword/Windows">Windows</a>から<a class="keyword" href="http://d.hatena.ne.jp/keyword/Linux">Linux</a>へtar.gzファイルを<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A2%A5%B9%A5%AD%A1%BC">アスキー</a>モードで送って、解凍したらファイルが壊れていたが、<br>
それに気付かず壊れたファイルをサーバへ設置してしまったとか。</p>

<h1>SFTPには転送モードはあるのか？</h1>

<p>SFTPを普段から使ってる人は転送モードなんて気にしたことあまりないと思う。<br>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/FTP">FTP</a>では気にしなければいけない転送モード、SFTPでは気にしなくていいのだろうか？</p>

<p>結論から言うと、SFTPには転送モードはないので、気にする必要はない。<br>
SFTPでは、<a class="keyword" href="http://d.hatena.ne.jp/keyword/FTP">FTP</a>でいうバイナリーモードでファイル転送をするようだ。</p>

<p>sftpコマンドのマニュアルにも特に転送モードについては記述がないのがわかる。<br>
<a href="http://www.unixuser.org/~euske/doc/openssh/jman/sftp.html">http://www.unixuser.org/~euske/doc/openssh/jman/sftp.html</a></p>

<h1>SFTPでも転送モードを選択できる場合がある！？</h1>

<p>ここで、SFTPにも転送モードはあるぞ！？と疑問を思った人もいるかもしれない。<br>
確かに<a class="keyword" href="http://d.hatena.ne.jp/keyword/WinSCP">WinSCP</a>などファイル転送ソフトを使っていると転送モードを選ぶことができる場合もある。</p>

<p>しかし、勘違いしてはいけないのが、<br>
転送モードを選ぶことができるのはSFTPの機能ではなくて<b>ファイル転送ソフトの機能</b>であるということだ。</p>

<h1>まとめ</h1>

<p><p>ファイル転送でよく使われる<a class="keyword" href="http://d.hatena.ne.jp/keyword/FTP">FTP</a>やSFTP。<br>
それぞれに違いはあるし、それを利用するソフトウェアによっても違いがある。<br>
何が何を行っているか把握し、思わぬミスを減らしましょう。</p>
</body></p>

                    </div>
                </section>
                
                
                
                <h1 class="content-subhead">11 Feb 2015, 17:21</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://mosuke.tech/entry/2015/02/11/172123/" class="post-title">SSHポートフォワード、https接続をするときに間違えやすいこと</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">mosuke5</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-SSH" href="https://mosuke.tech/categories/ssh">SSH</a><a class="post-category post-category-インフラ" href="https://mosuke.tech/categories/%E3%82%A4%E3%83%B3%E3%83%95%E3%83%A9">インフラ</a><a class="post-category post-category-ポートフォワード" href="https://mosuke.tech/categories/%E3%83%9D%E3%83%BC%E3%83%88%E3%83%95%E3%82%A9%E3%83%AF%E3%83%BC%E3%83%89">ポートフォワード</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p><body>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>ローカルフォワードの話。<br>
前回は簡単に実践してみたというのを書いたのだが、今度は実際に使ってみてハマった部分があったのでメモ。<br>
<a href="https://blog.mosuke.tech/entry/2014/12/31/170545">SSHでローカルポートフォワードを実際に試す - Goldstine研究所</a></p></p>

<h1>1. やりたいこと</h1>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/https">https</a>でしか接続を許可していないサーバへ、<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>ローカルフォワーディングを使って接続しようした。<br>
（直接疎通性がないためにポートフォワーディングする必要があった。）</p>

<h1>2. 行ったこと</h1>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/https">https</a>でしか接続ができないので、ローカル端末のポート5000を接続したいサーバのポート443に飛ばせばおっけーと思って、<br>
下記のように<a class="keyword" href="http://d.hatena.ne.jp/keyword/ssh">ssh</a>接続とブラウザから接続を行った。</p>

<pre><code>ssh -L5000:web-host:443 user@ssh-host 
</code></pre>

<p>※web-host: 今回<a class="keyword" href="http://d.hatena.ne.jp/keyword/https">https</a>で接続したサーバ<br>
※<a class="keyword" href="http://d.hatena.ne.jp/keyword/ssh">ssh</a>-host: <a class="keyword" href="http://d.hatena.ne.jp/keyword/ssh">ssh</a>接続先サーバ</p>

<p>これでローカルフォワーディングの設定は終わったので、ブラウザから以下に接続するだけで終わりだと思っていた。</p>

<pre><code>http://localhost:5000 
</code></pre>

<p>が、接続不可…なぜでしょう？</p>

<h1>3. 何が間違いだったか</h1>

<p>正しくは以下で接続をしなければいけない。http<b><span style="color: #ff0000">s</span></b>が必要。</p>

<pre><code>https://localhost:5000 
</code></pre>

<p>よーく考えればアタリマエのこと。<br>
URLのはじめの&lt;http(s)&gt;の部分は<b><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D7%A5%ED%A5%C8%A5%B3%A5%EB">プロトコル</a></b>で最後の&lt;:5000&gt;の部分は<b>ポート番号</b>。<br>
<u><b><a class="keyword" href="http://d.hatena.ne.jp/keyword/https">https</a>は443のポートを一般的に使うが、ポート443が<a class="keyword" href="http://d.hatena.ne.jp/keyword/https">https</a>というわけではない。</b></u></p>

<p><p>あたりまえのことだし知っていることなんだけど、見落としがちかもしれない。</p>
</body></p>

                    </div>
                </section>
                
                
            </div>
            
<div class="pagination">
  <nav role="pagination" class="post-list-pagination">
      
      <a href="/page/8/" class="post-list-pagination-item pure-button post-list-pagination-item-prev">
        <i class="fa fa-angle-double-left"></i>&nbsp;Newer
      </a>
      
    <span class="post-list-pagination-item post-list-pagination-item-current">Page 9 of 15</span>
    
      <a href="/page/10/" class="post-list-pagination-item pure-button post-list-pagination-item-next">
        Older&nbsp;<i class="fa fa-angle-double-right"></i>
      </a>
    
  </nav>
</div>


            <hr class="footer-hr" />
<div class="">
    <div class="google-search-engine">
        <script>
          (function() {
            var cx = '012458736543810277235:x4juxtghjhg';
            var gcse = document.createElement('script');
            gcse.type = 'text/javascript';
            gcse.async = true;
            gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(gcse, s);
          })();
        </script>
		    <gcse:search></gcse:search>
    </div>
    <a class="pure-button" href="https://about.mosuke.tech "><i class="fa fa-user"></i> mosuke5</a>
    <a class="pure-button" href="/archive/"><i class="fa fa-archive"></i> Arvhive</a>
    <a class="pure-button" href="https://mosuke.tech/index.xml"><i class="fa fa-rss"></i> rss</a>
</div>
<div class="footer">
    <div class="pure-menu pure-menu-horizontal pure-menu-open">
        <ul>
            <li>&copy; <strong>mosuke5</strong> All rights reserved.<br />Powered by <a class="hugo" href="https://gohugo.io/" target="_blank">hugo</a></li>
        </ul>
    </div>
</div>
<script src="https://mosuke.tech/js/all.min.js"></script>

        </div>
    </div>
</div>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-99596316-1', 'auto');
ga('send', 'pageview');

</script>

</body>
</html>
