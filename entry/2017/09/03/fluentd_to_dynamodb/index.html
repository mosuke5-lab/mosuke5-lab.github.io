<!doctype html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NginxのログをFluentdでDynamoDBへ送る | Goldstine研究所</title>
    <meta name="msvalidate.01" content="9220008783970B337CA4AE8362168354" />
    <meta name="description" content="NginxのログをFluentdを使ってAWSのDynamoDBへの送信を行ってみました。Fluetndの基本的な使い方から、AWS DynamoDBへ送信するまで、設定のハマリポイントなどを紹介します。">
    <link rel="canonical" href="https://blog.mosuke.tech/entry/2017/09/03/fluentd_to_dynamodb/">
    <link rel="alternate" hreflang="ja" href="https://blog.mosuke.tech" />
    <meta name="generator" content="Hugo 0.27.1" />
    <meta name="twitter:card" content="summary">
    
    <meta name="twitter:title" content="NginxのログをFluentdでDynamoDBへ送る | Goldstine研究所">
    <meta name="twitter:description" content="NginxのログをFluentdを使ってAWSのDynamoDBへの送信を行ってみました。Fluetndの基本的な使い方から、AWS DynamoDBへ送信するまで、設定のハマリポイントなどを紹介します。">
    <meta name="twitter:site" content="@mosuke5" />
    <meta name="twitter:creator" content="@mosuke5" />
    <meta property="og:type" content="article">
    <meta property="og:title" content="NginxのログをFluentdでDynamoDBへ送る &middot; Goldstine研究所">
    <meta property="og:description" content="NginxのログをFluentdを使ってAWSのDynamoDBへの送信を行ってみました。Fluetndの基本的な使い方から、AWS DynamoDBへ送信するまで、設定のハマリポイントなどを紹介します。">
    <meta property="og:image" content="https://blog.mosuke.tech/image/ogp_image.jpg" />
    <meta property="og:site_name" content="Goldstine研究所" />
    <meta property="og:url" content="https://blog.mosuke.tech/entry/2017/09/03/fluentd_to_dynamodb/" />

    <link rel="stylesheet" href="https://blog.mosuke.tech/css/all.min.css">

    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="alternate" type="application/rss+xml" title="Goldstine研究所" href="https://blog.mosuke.tech/index.xml" />
    <link rel="icon" type="image/png" href="/image/favicon.ico">
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</head>
<body>


<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
    <div class="header">
        <hgroup>
            <h1 class="brand-title"><a href="https://blog.mosuke.tech">Goldstine研究所</a></h1>
            <h2 class="brand-tagline"> @mosuke5&#39;s Blog </h2>
        </hgroup>

        <nav class="nav">
            <ul class="nav-list">
                
                
            </ul>
        </nav>
    </div>
</div>


    <div class="content pure-u-1 pure-u-md-3-4">
        <div>
            
            <div class="posts">
                <h1 class="content-subhead">03 Sep 2017, 15:48</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.mosuke.tech/entry/2017/09/03/fluentd_to_dynamodb/" class="post-title">NginxのログをFluentdでDynamoDBへ送る</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">mosuke5</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-AWS" href="https://blog.mosuke.tech/categories/aws">AWS</a><a class="post-category post-category-dynamoDB" href="https://blog.mosuke.tech/categories/dynamodb">dynamoDB</a><a class="post-category post-category-Fluentd" href="https://blog.mosuke.tech/categories/fluentd">Fluentd</a><a class="post-category post-category-ログ" href="https://blog.mosuke.tech/categories/%E3%83%AD%E3%82%B0">ログ</a><a class="post-category post-category-Nginx" href="https://blog.mosuke.tech/categories/nginx">Nginx</a>
                            
                        </p>
                    </header>
                    <div class="post-description">
                        <p>NginxのログをFluentdを使ってAWSのdynamoDBへ送る実験を行ったので、そのメモを残します。<br />
Fluetnd自体あまり触ったことがなかったので、その入門から、AWS DynamoDBへ送信するまでを紹介します。</p>

<p></p>

<h2 id="はじめに">はじめに</h2>

<h3 id="環境">環境</h3>

<p>本ブログの実験環境は下記のとおりです。</p>

<ul>
<li>サーバ: AWS EC2, Ubuntu16.04</li>
<li>Fluentd: 0.12.35</li>
</ul>

<h3 id="どんな場面で使えるの">どんな場面で使えるの？</h3>

<p>WebサーバのログをわざわざFluetndを使ってDynamoDBへ送信する必要があるのか？どんなときに使えるのか？
そのあたりを少し説明したいと思います。</p>

<p>まず、サーバが複数ある環境では、とくにクラウドのようにサーバの台数が増減する環境では、ログの集約は重要になってきます。AWSをはじめクラウドサービスではオブジェクトストレージのサービス(AWSならS3)があることが多く、オブジェクトストレージにログを集めることもよく紹介されます。
しかし、オブジェクトストレージの特性上、リアルタイムでの処理は向いていません。</p>

<p>DynamoDBのようなスケーラビリティに特徴のもつデータストアを利用することで、大量のログデータもリアルタイムに書き込みができ、冗長化もユーザ視点では気にする必要がありません。大量のログデータの集約に役立つソリューションになるでしょう。</p>

<p>また、FluentdはRaspberry PiのようなIoTデバイスでも利用することができます。
IoTデバイスから直接DynamoDBへログを送信することができればスケーラビリティの面でも安心ですよね。</p>

<p><img src="/image/fluentd_usage_overview.png" alt="fluentd-usage-overview" /></p>

<h2 id="fluetndインストールと入門">Fluetndインストールと入門</h2>

<h3 id="インストール">インストール</h3>

<p>Fluetndのインストールはとても簡単です。<br />
以下のページの各OSの&rdquo;Installation Guide&rdquo;を見るといいでしょう。<br />
<a href="https://www.fluentd.org/download">https://www.fluentd.org/download</a></p>

<p>今回はUbuntu16.04環境で行いました。レポジトリからのインストールをします。
インストールしたら起動と、起動できたかの確認を行ってみます。</p>

<pre><code>$ curl -L https://toolbelt.treasuredata.com/sh/install-ubuntu-xenial-td-agent2.sh | sh
$ sudo systemctl start td-agent
$ sudo systemctl status td-agent
● td-agent.service - LSB: data collector for Treasure Data
   Loaded: loaded (/etc/init.d/td-agent; bad; vendor preset: enabled)
   Active: active (running) since Sun 2017-09-03 06:41:59 UTC; 27min ago
     Docs: man:systemd-sysv-generator(8)
  Process: 2083 ExecStop=/etc/init.d/td-agent stop (code=exited, status=0/SUCCESS)
  Process: 2127 ExecStart=/etc/init.d/td-agent start (code=exited, status=0/SUCCESS)
    Tasks: 27
   Memory: 236.1M
      CPU: 1.951s
   CGroup: /system.slice/td-agent.service
           ├─2153 /opt/td-agent/embedded/bin/ruby /usr/sbin/td-agent --log /var/log/td-agent/td-agent.log --daemon /var/run/td-agent/td-agent.pid
           ├─2156 /opt/td-agent/embedded/bin/ruby /usr/sbin/td-agent --log /var/log/td-agent/td-agent.log --daemon /var/run/td-agent/td-agent.pid
           ├─2162 /opt/td-agent/embedded/bin/ruby /usr/sbin/td-agent --log /var/log/td-agent/td-agent.log --daemon /var/run/td-agent/td-age.pid
           └─2171 /opt/td-agent/embedded/bin/ruby /usr/sbin/td-agent --log /var/log/td-agent/td-agent.log --daemon /var/run/td-agent/td-agent.pid
</code></pre>

<h3 id="hello-fluentd">Hello Fluentd</h3>

<p>まずはFluetndがどういうものか理解するために、一番単純な例を試してみます。<br />
NignxのログをFluetndを使って別のファイルに書き出してみます。</p>

<p>まずはNginxのインストールをします。<br />
fluetndからNginxのログファイルが閲覧できるように権限の変更は忘れずに行ってください。</p>

<pre><code>$ sudo apt-get install nginx
$ sudo systemctl start nginx
$ curl localhost
  // ちゃんとHTMLが返ってくればOK
$ sudo chmod 644 /var/log/nginx/access.log
  // Fluentdからログファイルが読み取れるようにします。
</code></pre>

<p>次に、Fluetndの設定をいます。<br />
そもそもFluentdの基本的な考え方は、インプットとアウトプットです。
どのようにFluentdにデータをインプットするか、またそれをどのようにアウトプットするかを指定して利用します。
（アウトプットするにあたってフィルターなどかけられる）</p>

<p>Nginxのログを入力には、<code>tail</code>を今回利用します。
<code>tail</code>という名前からもう想像もできるかもしれませんが、ファイルを監視しIOイベントを読み取って、追記された情報に対して処理を行っていきます。</p>

<p>以下の設定ファイルで、<code>format</code>部分が少し難しそうに見えますが、アクセスログの内容をFluetnd側でJsonに変換できるように形式を指定しているだけです。以下参考にしています。<br />
<a href="http://qiita.com/liubin/items/92a4e7e3917143ae4aaf">http://qiita.com/liubin/items/92a4e7e3917143ae4aaf</a></p>

<p>アウトプットは<code>file</code>タイプを選択し、<code>/tmp</code>以下にファイルとして出力するようにします。</p>

<pre><code>$ sudo vim /etc/td-agent/td-agent.conf
&lt;source&gt;
  type tail
  path /var/log/nginx/access.log
  format /^(?&lt;remote&gt;[^ ]*) (?&lt;host&gt;[^ ]*) (?&lt;user&gt;[^ ]*) \[(?&lt;time&gt;[^\]]*)\] &quot;(?&lt;method&gt;\S+)(?: +(?&lt;path&gt;[^ ]*) +\S*)?&quot; (?&lt;code&gt;[^ ]*) (?&lt;size&gt;[^ ]*)(?: &quot;(?&lt;referer&gt;[^\&quot;]*)&quot; &quot;(?&lt;agent&gt;[^\&quot;]*)&quot; &quot;(?&lt;forwarder&gt;[^\&quot;]*)&quot;)?/
  time_format %d/%b/%Y:%H:%M:%S %z
  tag nginx.access
  pos_file /var/log/td-agent/nginx.pos
&lt;/source&gt;

&lt;match nginx.access&gt;
  type file
  path /tmp/output_nignx_access_log
&lt;/match&gt;
</code></pre>

<p>設定が完了したらfluetndを再起動して、curlでNginxにアクセスします。<br />
何回かアクセスするといいと思います。</p>

<pre><code>$ sudo systemctl restart td-agent
$ curl localhost
</code></pre>

<p>さて、<code>/tmp</code>以下に出力できているか確認します。<br />
ついでに中身をのぞいてみると、Nginxのログの内容がJsonになって出力されていることが確認できます。</p>

<pre><code>$ ls -l /tmp/
-rw-r--r--  1 td-agent td-agent  552 Sep  3 06:14 output_nignx_access_log.20170903.b55842e6a17fff571

$ cat /tmp/output_nignx_access_log.20170903.b55842e6a17fff571
2017-09-03T06:13:11+00:00       nginx.access    {&quot;remote&quot;:&quot;127.0.0.1&quot;,&quot;host&quot;:&quot;-&quot;,&quot;user&quot;:&quot;-&quot;,&quot;method&quot;:&quot;GET&quot;,&quot;path&quot;:&quot;/&quot;,&quot;code&quot;:&quot;200&quot;,&quot;size&quot;:&quot;11321&quot;}
2017-09-03T06:13:17+00:00       nginx.access    {&quot;remote&quot;:&quot;127.0.0.1&quot;,&quot;host&quot;:&quot;-&quot;,&quot;user&quot;:&quot;-&quot;,&quot;method&quot;:&quot;GET&quot;,&quot;path&quot;:&quot;/&quot;,&quot;code&quot;:&quot;200&quot;,&quot;size&quot;:&quot;11321&quot;}
</code></pre>

<h2 id="dynamodbへのログ送信">dynamoDBへのログ送信</h2>

<p>では、続いてDynamoDBへのログ送信をおこなっていきます。</p>

<h3 id="dynamodbのテーブル作成">dynamoDBのテーブル作成</h3>

<p>DynamoDBのテーブルを作成しますが、今回は難しいことは何もしません。
下記の通りでテーブルを作ります。</p>

<ul>
<li>テーブル名: mosuke5-test</li>
<li>プライマリーキー: id, 文字列</li>
</ul>

<h3 id="プラグインの設定">プラグインの設定</h3>

<p>fluetndからDynamoDBへ書き込むには、プラグインを別途インストールする必要があります。こちらのプラグインを使用していきます。<br />
<a href="https://github.com/gonsuke/fluent-plugin-dynamodb">https://github.com/gonsuke/fluent-plugin-dynamodb</a></p>

<p>インプットは先程と変えずに、アウトプットをDynamoDBに変更し使っていきます。<br />
設定は以下のとおりです。</p>

<pre><code>$ sudo td-agent-gem install fluent-dynamodb-plugin
$ sudo vim /etc/td-agent/td-agent.conf
&lt;match nginx.access&gt;
  @type dynamodb
  aws_key_id xxxxxxxxxxxxxxx
  aws_sec_key xxxxxxxxxxxxxxxxxxxxxxxxxx
  dynamo_db_region ap-northeast-1
  dynamo_db_endpoint https://dynamodb.ap-northeast-1.amazonaws.com
  dynamo_db_table mosuke5-test
&lt;/match&gt;

# 変更したら再起動しましょう
$ sudo systemctl restart td-agent
</code></pre>

<p>ではcurlでWebサーバへアクセスした後に、AWSコンソールからDynamoDBをみてみましょう。<br />
きちんとDynamoDBへログが保存されていることが確認できるかとおもいます。
ちなみにIDはプラグインの方で自動で付与しているものです。</p>

<p><img src="/image/fluentd_dynamodb_console.jpg" alt="fluentd-dynamodb-console" /></p>

<h3 id="設定tips">設定Tips</h3>

<p>fluent-dynamodb-pluginを設定する上で、ハマったポイントがあったので書いておきます。</p>

<ul>
<li><code>dynaamo_db_region</code>を設定しよう

<ul>
<li><code>dynamo_db_region</code>を指定しないと、「<a href="http://docs.aws.amazon.com/ja_jp/opsworks/latest/userguide/common-issues.html#common-issues-instance-registration-valid-region">Credential Should Be Scoped to a Valid Region (認証情報の範囲を有効なリージョンに限定する必要があります)</a>」のエラーが出るの注意。</li>
</ul></li>
<li>endpointにhttps(or http)をつけよう

<ul>
<li><code>dynamo_db_endpoint</code>には<code>https(or http)</code>をつけましょう。</li>
</ul></li>
</ul>

<h2 id="さいごに">さいごに</h2>

<p>とても簡単な例でしたが、Fluentdの初歩的な使い方から、DynamoDBへのログの書き込みまで理解できましたでしょうか。<br />
設定方法も重要ですが、大事なのは冒頭にも書いた、これがどのような場面で役立つソリューションであるか、ほかのログ収集ソリューションとはどこが特徴的であるかです。<br />
そのあたりの振り返りにご活用いただければと思います。</p>
                    </div>
                    
                    <div class="post-share">
                        <div class="post-share-links">
                            <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="basic-label-counter" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
                            <a class="twitter-share-button"
                            href="https://twitter.com/intent/tweet">
                          Tweet</a>
                            <iframe src="https://www.facebook.com/plugins/share_button.php?href=https%3a%2f%2fblog.mosuke.tech%2fentry%2f2017%2f09%2f03%2ffluentd_to_dynamodb%2f&layout=button_count&size=small&mobile_iframe=true&appId=1383467145023614&width=90&height=20" width="90" height="20" style="border:none;overflow:hidden" scrolling="no" frameborder="0" allowTransparency="true"></iframe>
                        </div>
                    </div>
                </section>
            </div>
            <hr class="footer-hr" />
<div class="latest-posts">
    <h5>Latest Posts</h5>
    
        <li><a href="https://blog.mosuke.tech/entry/2017/11/25/security_study/">SecurityStudy#2でパブリッククラウドのセキュリティについて話してきた</a></li>
    
        <li><a href="https://blog.mosuke.tech/entry/2017/11/10/acp/">Alibaba Cloud Professionalの認定取ってきた！</a></li>
    
        <li><a href="https://blog.mosuke.tech/entry/2017/11/03/serverlessconf_tokyo/">今年も、Serverlessconf Tokyo(2017)に参加してきた</a></li>
    
        <li><a href="https://blog.mosuke.tech/entry/2017/10/06/nobolycloud/">nobolycloudのポッドキャストでAlibaba Cloudについて話してきた</a></li>
    
        <li><a href="https://blog.mosuke.tech/entry/2017/09/18/aws_solution_architect/">【合格】AWSソリューションアーキテクト Associate認定試験</a></li>
    
</div>
<div class="search">
    <h5>Search(Beta)</h5>
    <p>この機能は、ElasticSearchを用いた全文検索エンジンです。Beta版。</p>
    <div class="gill-search-engine">
        <input type="text" id="search-textbox" placeholder="Search">
        <button id="search-btn">Search</button>
    </div>
    <div id="search-result"></div>
</div>
<div class="links">
    <h5>Links</h5>
    <a class="pure-button" href="https://mosuke.tech"><i class="fa fa-user"></i> mosuke5</a>
    <a class="pure-button" href="/about/"><i class="fa fa-info-circle"></i> About this site</a>
    <a class="pure-button" href="/archive/"><i class="fa fa-archive"></i> Arvhive</a>
    <a class="pure-button" href="https://blog.mosuke.tech/index.xml"><i class="fa fa-rss"></i> rss</a>
</div>
<div class="footer">
    <div class="pure-menu pure-menu-horizontal pure-menu-open">
        <ul>
            <li>&copy; <strong>mosuke5</strong> All rights reserved.<br />Powered by <a class="hugo" href="https://gohugo.io/" target="_blank">hugo</a></li>
        </ul>
    </div>
</div>
<script src="https://blog.mosuke.tech/js/all.min.js"></script>
<script>
        $(function() {
            $('#search-btn').click(function(e) {
                $('#search-result').empty();
                search($('#search-textbox').val())
                    .done(function(result){
                        $.each(result.hits.hits, function(){
                            $("#search-result").append("<li><a href=" + this._source.uri +">"+ this._source.title +"</a>("+this._score+")</li>");
                        })
                    }).fail(function(){
                        $('#search-result').append("<p>error</p>");
                    })
            });
        });
        function search(query){
            return $.ajax({
                type: "GET",
                url: "https://gill-search.mosuke.tech/search",
                data: "q=" + query,
                dataType: "json",
                success: function(res){
                    console.log(res);
                }
            })
        }
        </script>
        </div>
    </div>
</div>
<script>
window.twttr = (function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0],
      t = window.twttr || {};
    if (d.getElementById(id)) return t;
    js = d.createElement(s);
    js.id = id;
    js.src = "https://platform.twitter.com/widgets.js";
    fjs.parentNode.insertBefore(js, fjs);
  
    t._e = [];
    t.ready = function(f) {
      t._e.push(f);
    };
  
    return t;
}(document, "script", "twitter-wjs"));
</script>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-99596316-1', 'auto');
ga('send', 'pageview');

</script>

</body>
</html>
