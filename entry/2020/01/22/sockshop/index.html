<!doctype html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sock Shopを使ったマイクロサービス体験のハンズオン | Goldstine研究所</title>
    <meta name="msvalidate.01" content="9220008783970B337CA4AE8362168354" />
    <meta name="propeller" content="78ffb64bf8546f1b32b8a4e4400f4c06">
    <meta name="description" content="Sock Shopを使ってマイクロサービスの体験をしていきます。マイクロサービスの特徴や課題を体験できるようにシナリオを作りました。ただ起動して終わりではなく、Sock Shopからより多くのことを学ぶきっかけとなればと思います。">
    <link rel="canonical" href="https://blog.mosuke.tech/entry/2020/01/22/sockshop/">
    <link rel="alternate" hreflang="ja" href="https://blog.mosuke.tech/entry/2020/01/22/sockshop/" />
    <meta name="generator" content="Hugo 0.71.1" />
    <meta name="twitter:card" content="summary">
    
    <meta name="twitter:title" content="Sock Shopを使ったマイクロサービス体験のハンズオン | Goldstine研究所">
    <meta name="twitter:description" content="Sock Shopを使ってマイクロサービスの体験をしていきます。マイクロサービスの特徴や課題を体験できるようにシナリオを作りました。ただ起動して終わりではなく、Sock Shopからより多くのことを学ぶきっかけとなればと思います。">
    <meta name="twitter:site" content="@mosuke5" />
    <meta name="twitter:creator" content="@mosuke5" />
    <meta property="og:type" content="article">
    <meta property="og:title" content="Sock Shopを使ったマイクロサービス体験のハンズオン &middot; Goldstine研究所">
    <meta property="og:description" content="Sock Shopを使ってマイクロサービスの体験をしていきます。マイクロサービスの特徴や課題を体験できるようにシナリオを作りました。ただ起動して終わりではなく、Sock Shopからより多くのことを学ぶきっかけとなればと思います。">
    <meta property="og:image" content="https://blog.mosuke.tech/image/goldstine-lab-logo.png" />
    <meta property="og:site_name" content="Goldstine研究所" />
    <meta property="og:url" content="https://blog.mosuke.tech/entry/2020/01/22/sockshop/" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css">
    <link rel="stylesheet" href="https://blog.mosuke.tech/css/all.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="alternate" type="application/rss+xml" title="Goldstine研究所" href="https://blog.mosuke.tech/index.xml" />
    <link rel="icon" type="image/png" href="/image/favicon.ico">
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-2753210161325997",
        enable_page_level_ads: true
      });
    </script>
</head>
<body>


<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
    <div class="header">
        <hgroup>
            <h1 class="brand-title"><a href="https://blog.mosuke.tech">Goldstine研究所</a></h1>
            <h2 class="brand-tagline"> @mosuke5&#39;s Blog </h2>
        </hgroup>

        <nav class="nav">
            <ul class="nav-list">
                
                
            </ul>
        </nav>
    </div>
</div>


    <div class="content pure-u-1 pure-u-md-3-4">
        <div>
            
            <div class="posts">
                <h1 class="content-subhead">22 Jan 2020, 14:44</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.mosuke.tech/entry/2020/01/22/sockshop/" class="post-title">Sock Shopを使ったマイクロサービス体験のハンズオン</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">mosuke5</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-アプリケーション開発" href="https://blog.mosuke.tech/categories/%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E9%96%8B%E7%99%BA">アプリケーション開発</a><a class="post-category post-category-Kubernetes" href="https://blog.mosuke.tech/categories/kubernetes">Kubernetes</a>
                            
                        </p>
                    </header>
                    <div class="post-description">
                        <p>あけましておめでとうございます。<a href="https://twitter.com/mosuke5" target="_blank">@mosuke5</a>です。<br>
マイクロサービスの実際の体験や研修を探したことがありますでしょうか。
残念ながら、実際に手を動かしなら学ぶトレーニングや研修は多く存在しませんが、
マイクロサービスのデモアプリケーションとして<a href='https://microservices-demo.github.io/' target='_blank'>Sock Shop</a>が有名で、これはトレーニングに最適です。</p>
<p>日本語でもたくさんのSock Shopの紹介やインストール記事がでています。しかし、自分もそうだったのですが、なんとなく起動して動かして、終わりとなっているものがおおく、どんな観点でこのSock Shopをいじっていけばいいかの情報が足りないと感じました。
機会があり、Sock Shopをさわるタイミングがあったので、実際にどんなデータ構造になっているのか、マイクロサービスゆえの課題など、Sock Shopから少しでも多くの学びが得られるようにこの記事を書きます。</p>
<h2 id="sock-shopを動かす">Sock Shopを動かす</h2>
<p>Sock Shopはdocker-composeを始め、Kubernetesなど多様な環境で動かせるようになっています。
この記事では、Kubernetesを例に書きますが、どの環境で動かしていただいても構いません。
本ブログでは起動方法については割愛します。お好みの環境で動かしてみてください。</p>
<p>また、OpenShift上でSock Shopを動かしたい場合は<a href="https://github.com/mosuke5/microservices-demo-openshift">こちらのレポジトリ</a>も参考にしてください。</p>
<h2 id="sock-shopのアーキテクチャ">Sock Shopのアーキテクチャ</h2>
<p>Sock Shopのデザインは下記の通りで、Java, NodeJS, Goなどとマイクロサービスの特徴であるポリグロットを体現しています。
ポリグロットな構成に「できる」、というだけで戦略なしに「やっていい」というわけではないので、この点は誤解ないように理解していきましょう。詳細は<a href="front-end-rh-mori-sock-shop.3d6a.kepcodevops.openshiftapps.com">こちら</a>。</p>
<p><img src="/image/sockshop-architecture.png" alt="application-design"></p>
<h2 id="データ構造を見る">データ構造を見る</h2>
<p>まずは、データ構造を見ていきます。<br>
マイクロサービスでは、どこのサービスでどのようにデータを持つかは非常に重要です。
Sock Shopではデータベースを持つサービスが4つあります。
下では、サンプルの出力結果を表示しておきますが、ぜひ自分の目で確かめていくといいです。</p>
<ul>
<li>catalogue (mysql)</li>
<li>user (mongodb)</li>
<li>cart (mongodb)</li>
<li>order (mongodb)</li>
</ul>
<h3 id="catalogue">catalogue</h3>
<p>靴下の商品情報や、靴下のタグの情報を管理するcatalogueサービスのデータベース構造を示します。
MySQLを利用しており、非常にわかりやすいデータ構造となっています。
<code>sock</code>テーブルでは靴下の情報を<code>tag</code>テーブルでは靴下のタグ情報を管理しており、それらは1対nの関係性なので、<code>sock_tag</code>テーブルで中間テーブルとして機能させています。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">mysql&gt; desc sock;
+-------------+--------------+------+-----+---------+-------+
| Field       | Type         | Null | Key | Default | Extra |
+-------------+--------------+------+-----+---------+-------+
| sock_id     | varchar(40)  | NO   | PRI | NULL    |       |
| name        | varchar(20)  | YES  |     | NULL    |       |
| description | varchar(200) | YES  |     | NULL    |       |
| price       | float        | YES  |     | NULL    |       |
| count       | int(11)      | YES  |     | NULL    |       |
| image_url_1 | varchar(40)  | YES  |     | NULL    |       |
| image_url_2 | varchar(40)  | YES  |     | NULL    |       |
+-------------+--------------+------+-----+---------+-------+

mysql&gt; desc sock_tag;
+---------+--------------+------+-----+---------+-------+
| Field   | Type         | Null | Key | Default | Extra |
+---------+--------------+------+-----+---------+-------+
| sock_id | varchar(40)  | YES  | MUL | NULL    |       |
| tag_id  | mediumint(9) | NO   | MUL | NULL    |       |
+---------+--------------+------+-----+---------+-------+

mysql&gt; desc tag;
+--------+--------------+------+-----+---------+----------------+
| Field  | Type         | Null | Key | Default | Extra          |
+--------+--------------+------+-----+---------+----------------+
| tag_id | mediumint(9) | NO   | PRI | NULL    | auto_increment |
| name   | varchar(20)  | YES  |     | NULL    |                |
+--------+--------------+------+-----+---------+----------------+

mysql&gt; select * from tag;
+--------+--------+
| tag_id | name   |
+--------+--------+
|      1 | brown  |
|      2 | geek   |
|      3 | formal |
|      4 | blue   |
|      5 | skin   |
|      6 | red    |
|      7 | action |
|      8 | sport  |
|      9 | black  |
|     10 | magic  |
|     11 | green  |
+--------+--------+
</code></pre></div><h3 id="user">user</h3>
<p>続いて、ユーザを管理するサービスです。
mongodbのcollectionは3つ存在します。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">&gt; show collections;
addresses
cards
customers

&gt; db.customers.find()
{
  &#34;_id&#34; : ObjectId(&#34;57a98d98e4b00679b4a830af&#34;),
  &#34;firstName&#34; : &#34;Eve&#34;,
  &#34;lastName&#34; : &#34;Berger&#34;,
  &#34;username&#34; : &#34;Eve_Berger&#34;,
  &#34;password&#34; : &#34;fec51acb3365747fc61247da5e249674cf8463c2&#34;,
  &#34;salt&#34; : &#34;c748112bc027878aa62812ba1ae00e40ad46d497&#34;,
  &#34;addresses&#34; : [ ObjectId(&#34;57a98d98e4b00679b4a830ad&#34;) ],
  &#34;cards&#34; : [ ObjectId(&#34;57a98d98e4b00679b4a830ae&#34;) ]
}

&gt; db.cards.find()
{
  &#34;_id&#34; : ObjectId(&#34;57a98d98e4b00679b4a830ae&#34;),
  &#34;longNum&#34; : &#34;5953580604169678&#34;,
  &#34;expires&#34; : &#34;08/19&#34;,
  &#34;ccv&#34; : &#34;678&#34;
}

&gt; db.addresses.find()
{
  &#34;_id&#34; : ObjectId(&#34;57a98d98e4b00679b4a830ad&#34;),
  &#34;street&#34; : &#34;ebisu street&#34;,
  &#34;number&#34; : &#34;1-1-1&#34;,
  &#34;country&#34; : &#34;japan&#34;,
  &#34;city&#34; : &#34;tokyo&#34;,
  &#34;postcode&#34; : &#34;111-1111&#34;,
  &#34;links&#34; : {  }
}
</code></pre></div><h3 id="cart">cart</h3>
<p>次は、ショッピングカートです。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">&gt; show collections
cart
item

&gt; db.cart.find()
{
  &#34;_id&#34; : ObjectId(&#34;5e20278e03277a00079dd215&#34;),
  &#34;_class&#34; : &#34;works.weave.socks.cart.entities.Cart&#34;,
  &#34;customerId&#34; : &#34;5e184694b6c6850001a762da&#34;,
  &#34;items&#34; : [
    DBRef(&#34;item&#34;, ObjectId(&#34;5e2115f003277a00079dd217&#34;))
  ]
}

&gt; db.item.find()
{
  &#34;_id&#34; : ObjectId(&#34;5e2115f003277a00079dd217&#34;),
  &#34;_class&#34; : &#34;works.weave.socks.cart.entities.Item&#34;,
  &#34;itemId&#34; : &#34;510a0d7e-8e83-4193-b483-e27e09ddc34d&#34;,
  &#34;quantity&#34; : 1,
  &#34;unitPrice&#34; : 15
}
...
</code></pre></div><h3 id="order">order</h3>
<p>最後は、注文履歴を管理するorderサービスです。<br>
orderサービスの中では、注文した商品のIDのみ保有し、そのデータは持っていないことは少し頭の片隅に覚えておいてください。
後ほど、サービスをまたいだデータの取得に関して考えていきます。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">&gt; show collections;
customerOrder

&gt; db.customerOrder.find()
{
  &#34;_id&#34; : ObjectId(&#34;5e197a445196950008004bf1&#34;),
  &#34;_class&#34; : &#34;works.weave.socks.orders.entities.CustomerOrder&#34;,
  &#34;customerId&#34; : &#34;5e184694b6c6850001a762da&#34;,
  &#34;customer&#34; : {
    &#34;_id&#34; : null,
    &#34;firstName&#34; : &#34;shinya&#34;,
    &#34;lastName&#34; : &#34;mori&#34;,
    &#34;username&#34; : &#34;mosuke5&#34;,
    &#34;addresses&#34; : [ ],
    &#34;cards&#34; : [ ]
  },
  &#34;address&#34; : {
    &#34;_id&#34; : null,
    &#34;number&#34; : &#34;1-1-1&#34;,
    &#34;street&#34; : &#34;ebisu street&#34;,
    &#34;city&#34; : &#34;tokyo&#34;,
    &#34;postcode&#34; : &#34;111-1111&#34;,
    &#34;country&#34; : &#34;japan&#34;
  },
  &#34;card&#34; : {
    &#34;_id&#34; : null,
    &#34;longNum&#34; : &#34;111111111&#34;,
    &#34;expires&#34; : &#34;03.22&#34;,
    &#34;ccv&#34; : &#34;111&#34;
  },
  &#34;items&#34; : [
    {
      &#34;_id&#34; : ObjectId(&#34;5e184c4b03277a00079dd204&#34;),
      &#34;itemId&#34; : &#34;3395a43e-2d88-40de-b95f-e00e1502085b&#34;,
      &#34;quantity&#34; : 1,
      &#34;unitPrice&#34; : 18 
    },
    {
      &#34;_id&#34; : ObjectId(&#34;5e197a2703277a00079dd206&#34;),
      &#34;itemId&#34; : &#34;510a0d7e-8e83-4193-b483-e27e09ddc34d&#34;,
      &#34;quantity&#34; : 1,
      &#34;unitPrice&#34; : 15
    },
    {
      &#34;_id&#34; : ObjectId(&#34;5e197a2f03277a00079dd207&#34;),
      &#34;itemId&#34; : &#34;808a2de1-1aaa-4c25-a9b9-6612e8f29a38&#34;,
      &#34;quantity&#34; : 1,
      &#34;unitPrice&#34; : 17.31999969482422
    },
    {
      &#34;_id&#34; : ObjectId(&#34;5e197a3203277a00079dd208&#34;),
      &#34;itemId&#34; : &#34;819e1fbf-8b7e-4f6d-811f-693534916a8b&#34;,
      &#34;quantity&#34; : 1,
      &#34;unitPrice&#34; : 14
    },
    {
      &#34;_id&#34; : ObjectId(&#34;5e197a3a03277a00079dd209&#34;),
      &#34;itemId&#34; : &#34;d3588630-ad8e-49df-bbd7-3167f7efb246&#34;,
      &#34;quantity&#34; : 1,
      &#34;unitPrice&#34; : 10.989999771118164
    },
    {
      &#34;_id&#34; : ObjectId(&#34;5e197a3e03277a00079dd20a&#34;),
      &#34;itemId&#34; : &#34;a0a4f044-b040-410d-8ead-4de0446aec7e&#34;,
      &#34;quantity&#34; : 1,
      &#34;unitPrice&#34; : 7.989999771118164
    }
  ],
  &#34;shipment&#34; : {
    &#34;_id&#34; : &#34;70a338f4-f40c-4512-86c7-5ad6ed8d57eb&#34;,
    &#34;name&#34; : &#34;5e184694b6c6850001a762da&#34; 
  },
  &#34;date&#34; : ISODate(&#34;2020-01-11T07:33:24.861Z&#34;),
  &#34;total&#34; : 88.29000091552734
}
</code></pre></div><h3 id="データ分割による弊害">データ分割による弊害</h3>
<p>このアプリケーションではマイクロサービス特有のデータの分割による問題がしっかり発生しています。<br>
靴下を注文したあと、注文履歴を見るページでは、注文の情報と注文した商品の情報の両方を表示しています。
しかし、catalogueとorderの2つでサービスを分離しているため、これらの情報をまとめて取得することができません。</p>
<p><img src="/image/sockshop-order-screen.png" alt="sockshop-order-screen"></p>
<p>では、どのように取得しているか見ていきます。<br>
下記のように、orderサービスに問い合わせたあと、注文した商品を別でcatalogueサービスに問い合わせにいっています。
いわゆるN+1問題が発生しています(&lt;a href-&ldquo;<a href="https://github.com/microservices-demo/front-end/blob/5e21067c2011a1f220322a704c9984fa206c4d12/public/customer-order.html#L205%22">https://github.com/microservices-demo/front-end/blob/5e21067c2011a1f220322a704c9984fa206c4d12/public/customer-order.html#L205&quot;</a> target=&rdquo;_blank&quot;&gt;該当のコード</a>)。
これは、マイクロサービスではよく発生します。</p>
<p><img src="/image/sockshop-order.png" alt="sockshop-order"></p>
<p>解決へのアプローチはいくつかあります。<br>
どれがいいということはなく、データの特性などによるのですが、以下のようなポイントを考えていくといいと思います。</p>
<ol>
<li>そもそもデータの特性はどうか？
<ul>
<li>リアルタイムに更新が必要な情報か。</li>
</ul>
</li>
<li>DBを非正規化して対応するか？</li>
<li>オーダー処理をイベントとして保存しておくか？</li>
<li>複数のitemを取得できるAPIをつくるか？</li>
<li>共有データベースにしてしまうか？</li>
<li>BFFで結合、キャッシュするか？</li>
<li>item情報を同期するか？CQRSパターンを採用するか？</li>
</ol>
<h2 id="apiを実行する">APIを実行する</h2>
<p>商品オーダーのAPIなどは当然ながら認証しないとと実行できません。
残念ながら、認証の方法などについてドキュメントに書いていなかったので補足していきます。
認証はクッキーを使います。<br>
試しに、ログインセッションを持たないまま、オーダーAPIを実行してみるとログインしてくれとエラーが返ってきます。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">$ curl -XGET $FRONTEND_ADDRESS/orders
{&#34;message&#34;:&#34;User not logged in.&#34;,&#34;error&#34;:{}}
</code></pre></div><p>ログインには&quot;username:password&quot;をbase64でエンコードしたものが必要です(<a href="https://github.com/microservices-demo/front-end/blob/5d9a4272fec3983250364917d8ea7a210cdbf58c/public/js/client.js#L23">該当コード</a>)。<br>
コマンドラインで生成するか、こちらのような<a href="https://uic.jp/base64encode/">Base64エンコードをしてくれるWebサービス</a>で生成しましょう。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">$ echo -n &#34;user:password&#34; | base64
dXNlcjpwYXNzd29yZA==

$ curl -XGET -c cookie.txt -H &#34;Authorization: Basic dXNlcjpwYXNzd29yZA==&#34; -v $FRONTEND_ADDRESS/login

$ cat cookie.txt
# Netscape HTTP Cookie File
# https://curl.haxx.se/docs/http-cookies.html
# This file was generated by libcurl! Edit at your own risk.

xxxxxxx
</code></pre></div><p>ログインができているか確認します。オーダー情報が返ってきていれば成功です。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">$ curl -XGET -b cookie.txt $FRONTEND_ADDRESS/orders
[
    {
        &#34;customerId&#34;: &#34;57a98d98e4b00679b4a830b2&#34;,
        &#34;customer&#34;: {
            &#34;firstName&#34;: &#34;User&#34;,
            &#34;lastName&#34;: &#34;Name&#34;,
            &#34;username&#34;: &#34;user&#34;,
            &#34;addresses&#34;: [],
            &#34;cards&#34;: []
        },
        &#34;address&#34;: {
            &#34;number&#34;: &#34;246&#34;,
            &#34;street&#34;: &#34;Whitelees Road&#34;,
            &#34;city&#34;: &#34;Glasgow&#34;,
            &#34;postcode&#34;: &#34;G67 3DL&#34;,
            &#34;country&#34;: &#34;United Kingdom&#34;
        },
        &#34;card&#34;: {
            &#34;longNum&#34;: &#34;5544154011345918&#34;,
            &#34;expires&#34;: &#34;08/19&#34;,
            &#34;ccv&#34;: &#34;958&#34;
        },
        &#34;items&#34;: [
            {
                &#34;itemId&#34;: &#34;808a2de1-1aaa-4c25-a9b9-6612e8f29a38&#34;,
                &#34;quantity&#34;: 1,
                &#34;unitPrice&#34;: 17.32
            }
        ],
        &#34;shipment&#34;: {
            &#34;name&#34;: &#34;57a98d98e4b00679b4a830b2&#34;
        },
        &#34;date&#34;: &#34;2019-12-23T06:35:49.925+0000&#34;,
        &#34;total&#34;: 22.31,
        &#34;_links&#34;: {
            &#34;self&#34;: {
                &#34;href&#34;: &#34;http://orders/orders/5e006045dc2f2e0006f35ee4&#34;
            },
            &#34;order&#34;: {
                &#34;href&#34;: &#34;http://orders/orders/5e006045dc2f2e0006f35ee4&#34;
            }
        }
    }
]
</code></pre></div><p>ログインさえできてしまえば、同じ要領で他のAPIも実行することが可能です。
APIは<a href="https://microservices-demo.github.io/api/index.html">こちらを参考</a>にしながら実行していくことが可能です。</p>
<h2 id="独立性回復性">独立性、回復性</h2>
<p>マイクロサービスのメリットの中には、サービスが独立することによる、デプロイやスケールのしやすさや回復性があります。
実際に特定のサービスの停止・スケール・デプロイをやってみます。</p>
<h3 id="cartsサービスの停止">cartsサービスの停止</h3>
<p>マイクロサービスの回復性について考えてみます。<br>
cartsサービスを落としてみて、どんな影響があるか確認してみます。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">$ kubectl scale --replicas=0 deployment/carts
</code></pre></div><ul>
<li>オーダーはできるか？</li>
<li>他のコンポーネントへの影響は？</li>
<li>ユーザ体験はどう変わったか？</li>
</ul>
<h4 id="デグレードの実装">デグレードの実装</h4>
<p>cartsサービスを落としたあと、UI上からカートボタンが消えました。（ボタンが消えるのにタイムラグがあるのはまあサンプル実装だから大目に見ようｗ）
これは、よくあるデグレードの考え方を実装しているからです。マイクロサービスでは、利用するマイクロサービスがどういう状態か把握し、防御的な実装をいれることがあります。
その１つの例になりますでしょうか。
<a href="https://github.com/microservices-demo/front-end/blob/5d9a4272fec3983250364917d8ea7a210cdbf58c/public/navbar.html#L227">該当のコード</a></p>
<h4 id="サーキットブレーカについて">サーキットブレーカについて</h4>
<p>cartsサービスを落とした状態で、ブラウザのデバッグツールを開いて、cartsサービスへの通信状況を見てみましょう。<br>
アクセスの度にcartsサービスのタイムアウトを待っているのがわかるのがわかります。
このサンプルではサーキットブレーカの実装は入っていません。こういった通信状況をみているとなぜサーキットブレーカが必要なのか、など感じてくるかと思います。</p>
<h3 id="front-endのスケールとデプロイ">front-endのスケールとデプロイ</h3>
<p>マイクロサービスのスケーリングについて考えてみます。<br>
マイクロサービスでは特定のサービスのみをスケールすることが容易であることが特徴の１つです。
以下、実行することは非常に簡単なわけですが、重要なのはそのサービスの独立性です。
１サービスで１チームと仮に想定した場合、チームの動きやすさを想像することができると思います。</p>
<p>ためしにフロントエンドサービスをスケールさせてみてみましょう。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">$ kubectl scale --replicas=3 deployment/front-end 
</code></pre></div><p>フロントエンドのコンテナイメージを変更してデプロイしてみます。<br>
サンプルで、背景色を変更したフロントエンドのイメージを用意しました。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: extensions/v1beta1
<span style="color:#66d9ef">kind</span>: Deployment
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: front-end
  <span style="color:#66d9ef">namespace</span>: sock-shop
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">replicas</span>: <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">template</span>:
    <span style="color:#66d9ef">metadata</span>:
      <span style="color:#66d9ef">labels</span>:
        <span style="color:#66d9ef">name</span>: front-end
    <span style="color:#66d9ef">spec</span>:
      <span style="color:#66d9ef">containers</span>:
      - <span style="color:#66d9ef">name</span>: front-end
        <span style="color:#66d9ef">image</span>: mosuke5/front-end:master-bd5039f4
        <span style="color:#75715e">#image: weaveworksdemos/front-end:0.3.12</span>
</code></pre></div><h2 id="非同期通信">非同期通信</h2>
<p>マイクロサービスアーキテクチャでは、サービス間の通信をどのように行うかは重要な選択の１つです。<br>
Sock Shopでも、アーキテクチャデザインの図を見ると、shippingサービスはRabbitMQに対してデータを送り、queue-masterが処理していることがわかります。</p>
<p><code>shipping</code>サービスと<code>queue-master</code>サービスのPodのログを見ながら、画面上からオーダー処理を行ってみましょう。
ログからキューへの書き込みおよび、キューからの受信を確認することができます。</p>
<p>非同期通信のメリットは、通信先の相手の状態に関係なく通信できることです。<br>
例えば、あなたがAWSなどのパブリッククラウドで仮想サーバを作成すると仮定します。
作成する仮想サーバの設定をしたあと、作成ボタンを押してから実際にできあがるまで約5分程度かかります。
同期的処理では、仮想サーバが出来上がるまでの間、ずっと待っていなければいけません。その間、ブラウザのタブを閉じたりしてはいけません。
非同期処理では、「仮想サーバの作成を受け付けました」とレスポンスを先に返すことが可能であり、実際の作成は裏側で行うことができます。
これにより、仮想サーバが出来上がるまでの間、自由に他のことをすることができます。<br>
一般的に、時間のかかる処理や、同期的な処理では間に合わない場合などに利用されることが多いです。</p>
<h2 id="トレーシング">トレーシング</h2>
<p>Soch Shopでは、トレーシングも体験することができます。
jaegerなどのコンポーネントをデプロイします。デプロイについてはドキュメントには書かれておらず、Githubにあるマニフェストファイルを使って起動することが必要です。
<a href="https://github.com/microservices-demo/microservices-demo/tree/master/deploy/kubernetes/manifests-jaeger">こちら</a>を参考にしてください。</p>
<p>下記のような画面にアクセスできれば成功です。</p>
<p><img src="/image/jaeger-query.png" alt="jaeger-query"></p>
<p>トレーシングのコンポーネント起動後に、もう一度Sock Shopで購入などの様々なアクションを実行しましょう。
起動後はSock Shop内でのアクションがjaeger内部に保存されていきます。
検索から<code>orders</code>サービスで検索をし、<code>orders: http:/orders</code>を探してみましょう。
靴下の注文処理の裏側では、userやpaymentなど複数のサービスにまたいで処理が行われていることがわかってきます。</p>
<p><img src="/image/jaeger-query-order.png" alt="jaeger-query-order"></p>
<p>paymentサービスに障害が起きたと仮定し、paymentサービスを落としたあとに、もう一度購入操作をしてみましょう。
この複雑な処理のなかでもどこでエラーが起きたか一目瞭然に確認することができます。</p>
<h2 id="フィードバック">フィードバック</h2>
<p>Sock Shopを使ったマイクロサービスの体験を紹介してきました。<br>
もっと〇〇なことも体験できるよ、とかシナリオとして入れたほうがいい、というものがあればリクエストください。
みなさんでマイクロサービスを理解するいいきっかけを作れればと思っています。</p>
<h2 id="参考文献">参考文献</h2>
<p>マイクロサービスを学習していく中でかなりお世話になった書籍があります。
デモアプリケーションで試すと同時にこちらの書籍での学習も進めてみてください。</p>
<div class="iframely-embed"><div class="iframely-responsive" style="height: 140px; padding-bottom: 0;"><a href="https://www.amazon.co.jp/%25E3%2583%259E%25E3%2582%25A4%25E3%2582%25AF%25E3%2583%25AD%25E3%2582%25B5%25E3%2583%25BC%25E3%2583%2593%25E3%2582%25B9%25E3%2582%25A2%25E3%2583%25BC%25E3%2582%25AD%25E3%2583%2586%25E3%2582%25AF%25E3%2583%2581%25E3%2583%25A3-Sam-Newman/dp/4873117607" data-iframely-url="//cdn.iframe.ly/bLsItzw?iframe=card-small"></a></div></div><script async src="//cdn.iframe.ly/embed.js" charset="utf-8"></script>
                    </div>
                    
                    
                    <div class="related-post">
                        <h5>関連する記事はこちら</h5>
                    	
                        <li><a href="https://blog.mosuke.tech/entry/2020/07/08/container-image-security/" onClick="ga('send','event','link','click','related-posts');">コンテナイメージのセキュリティに関する考え方</a> (2020/07/08)</li>
                    	
                        <li><a href="https://blog.mosuke.tech/entry/2020/07/05/customized-jenkins-on-openshift/" onClick="ga('send','event','link','click','related-posts');">カスタマイズしたJenkinsを作成する方法 on OpenShift</a> (2020/07/05)</li>
                    	
                        <li><a href="https://blog.mosuke.tech/entry/2020/07/01/istio-sockshop/" onClick="ga('send','event','link','click','related-posts');">Sock Shopを使ったサービスメッシュ体験のハンズオン</a> (2020/07/01)</li>
                    	
                        <li><a href="https://blog.mosuke.tech/entry/2020/05/10/tekton-operator/" onClick="ga('send','event','link','click','related-posts');">TektonのOperatorによるインストールとHello World</a> (2020/05/10)</li>
                    	
                        <li><a href="https://blog.mosuke.tech/entry/2020/04/28/kubernetes-image-puller/" onClick="ga('send','event','link','click','related-posts');">イメージのプルの効率化を考える。kubernetes-image-puller の紹介</a> (2020/04/28)</li>
                    	
                    </div>
                    
                    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "mosuke5-techblog" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                    <div class="post-share">
                        <div class="post-share-links">
                            <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="basic-label-counter" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
                            <a class="twitter-share-button"
                            href="https://twitter.com/intent/tweet">
                          Tweet</a>
                            <iframe src="https://www.facebook.com/plugins/share_button.php?href=https%3a%2f%2fblog.mosuke.tech%2fentry%2f2020%2f01%2f22%2fsockshop%2f&layout=button_count&size=small&mobile_iframe=true&appId=1383467145023614&width=90&height=20" width="90" height="20" style="border:none;overflow:hidden" scrolling="no" frameborder="0" allowTransparency="true"></iframe>
                        </div>
                    </div>
                </section>
            </div>
            <hr class="footer-hr" />
<div class="footer-posts">
    <h5>Latest Posts</h5>
    
        <li><a href="https://blog.mosuke.tech/entry/2020/07/08/container-image-security/" onClick="ga('send','event','link','click','latest-posts');">コンテナイメージのセキュリティに関する考え方</a></li>
    
        <li><a href="https://blog.mosuke.tech/entry/2020/07/05/customized-jenkins-on-openshift/" onClick="ga('send','event','link','click','latest-posts');">カスタマイズしたJenkinsを作成する方法 on OpenShift</a></li>
    
        <li><a href="https://blog.mosuke.tech/entry/2020/07/01/istio-sockshop/" onClick="ga('send','event','link','click','latest-posts');">Sock Shopを使ったサービスメッシュ体験のハンズオン</a></li>
    
        <li><a href="https://blog.mosuke.tech/entry/2020/05/10/tekton-operator/" onClick="ga('send','event','link','click','latest-posts');">TektonのOperatorによるインストールとHello World</a></li>
    
        <li><a href="https://blog.mosuke.tech/entry/2020/04/28/kubernetes-image-puller/" onClick="ga('send','event','link','click','latest-posts');">イメージのプルの効率化を考える。kubernetes-image-puller の紹介</a></li>
    
</div>
<div class="footer-posts">
    <h5>Featured Posts</h5>
    <li><a href="https://blog.mosuke.tech/entry/2016/06/04/180122/" onClick="ga('send','event','link','click','featured-posts');">Nginxの仕組みについて入門</a></li>
    <li><a href="https://blog.mosuke.tech/entry/2017/03/18/182252/" onClick="ga('send','event','link','click','featured-posts');">万能じゃない。オブジェクトストレージの仕組みと利用を正しく理解する</a></li>
    <li><a href="https://blog.mosuke.tech/entry/2015/07/19/135844/" onClick="ga('send','event','link','click','featured-posts');">DockerとWebSocketを使って、vimの設定をブラウザで即体感できるサービスを作った</a></li>
</div>
<div class="search">
    <h5>Search</h5>
    <div class="google-search">
    <script async src="https://cse.google.com/cse.js?cx=012458736543810277235:x4juxtghjhg"></script>
<div class="gcse-search"></div>
    </div>
</div>
<div class="links">
    <h5>Links</h5>
    <a class="pure-button" href="/about/" onClick="ga('send','event','link','click','about-this-site');"><i class="fa fa-info-circle"></i> About this site</a>
    <a class="pure-button" href="/archive/" onClick="ga('send','event','link','click','archive');"><i class="fa fa-archive"></i> Arvhive</a>
    <a class="pure-button" href="/categories/" onClick="ga('send','event','link','click','categories');"><i class="fa fa-tag"></i> Categories</a>
    <a class="pure-button" href="https://docs.google.com/forms/d/e/1FAIpQLSd6N53H7zfF8EBrvyezRizU1mQx-CP3vc_jG-WvxfRmCjHTpg/viewform" onClick="ga('send','event','link','click','contact');" target="_blank"><i class="fa fa-question-circle"></i> Contact</a>
    <a class="pure-button" href="https://blog.mosuke.tech/index.xml" onClick="ga('send','event','link','click','rss');"><i class="fa fa-rss"></i> rss</a>
</div>
<div class="footer">
    <div class="pure-menu pure-menu-horizontal pure-menu-open">
        <ul>
            <li>&copy; 2020 <strong>mosuke5</strong> All rights reserved.<br />Powered by <a class="hugo" href="https://gohugo.io/" target="_blank">hugo</a></li>
        </ul>
    </div>
</div>

        </div>
    </div>
</div>
<script>
window.twttr = (function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0],
      t = window.twttr || {};
    if (d.getElementById(id)) return t;
    js = d.createElement(s);
    js.id = id;
    js.src = "https://platform.twitter.com/widgets.js";
    fjs.parentNode.insertBefore(js, fjs);
  
    t._e = [];
    t.ready = function(f) {
      t._e.push(f);
    };
  
    return t;
}(document, "script", "twitter-wjs"));
</script>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-99596316-1', 'auto');
ga('send', 'pageview');

</script>

</body>
</html>
